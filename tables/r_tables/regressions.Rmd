---
title: "regressions"
author: "Chris Soria"
date: "2025-01-08"
output: html_document
---
#packages
```{r}
library(emmeans)
library(tidyverse)
library(broom)
library(cowplot)
library(writexl)
library(scales)
```
#prep
```{r}
target_dir <- normalizePath("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables")
current_dir <- normalizePath(getwd())

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots/")

} else {
  out_dir <- file.path("C:/Users/Ty/Desktop/ses_international/tables/r_tables//")
  data_dir <- file.path("C:/Users/Ty/Desktop/ses_international/data//")
  plot_dir <- file.path("C:/Users/Ty/Desktop/ses_international/plots//")

}

print(getwd())

us_df_2010_filtered <- us_df_2010 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"),
          year = haven::as_factor(year)) %>% 
  select(married_cohab, age_at_immigration_15to24, age_at_immigration_25to49, age_at_immigration_50plus, 
         yrimm_before1965, yrimm_1965to1980, yrimm_1980to1999, female,  
         country_string, lives_alone, english_speaker, secondary_or_above, 
         age_70to79, age_80to89, age_90plus, perwt, year, is_naturalized_citizen, less_than_primary_completed)

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"),
          year = haven::as_factor(year)) %>% 
  select(married_cohab, age_at_immigration_15to24, age_at_immigration_25to49, age_at_immigration_50plus, 
         yrimm_before1965, yrimm_1965to1980, yrimm_1980to1999, female,  
         country_string, lives_alone, english_speaker, secondary_or_above, 
         age_70to79, age_80to89, age_90plus, perwt, year, is_naturalized_citizen, less_than_primary_completed)

us_df_all <- rbind(us_df_2010_filtered, us_df_2020_filtered)
```
## outcome specific regressions (just for migrants)
## no controls
```{r}
dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", "is_naturalized_citizen", "less_than_primary_completed")
ivs <- c("country_string")
results_list <- list()

for (dv in dvs) {
  current_countries <- if (dv == "is_naturalized_citizen") {
    c("mexico", "dominican republic", "cuba")  # exclude when pr when dv is citizen
  } else {
    c("mexico", "puerto rico", "dominican republic", "cuba")
  }
  
  us_df_2020_filtered <- us_df_2020 %>% 
    filter(country_string %in% current_countries) %>% 
    mutate(country_string = fct_relevel(country_string, "mexico"))
    
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))
  print(formula)
  model <- lm(formula, data = us_df_2020_filtered,  # corrected: use 2020 version
               weights = perwt)
  results_list[[dv]] <- model
}

summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/2020_US_model_summaries_no_controls.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}
```
## full multivariate
```{r}
# turn model creation into a function
create_country_coefs <- function(data, sex_filter = NULL) {
  
  # apply sex filter if specified
  if (!is.null(sex_filter)) {
    data <- data %>% filter(sex == sex_filter)
  }
  
  dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
           "is_naturalized_citizen", "less_than_primary_completed")
  ivs <- c("country_string", "age_at_immigration_15to24","age_at_immigration_25to49", 
           "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", 
           "yrimm_1980to1999", "female", "english_speaker", "secondary_or_above", 
           "age_70to79", "age_80to89", "age_90plus")
  results_list <- list()
  
  for (dv in dvs) {
    current_countries <- if (dv == "is_naturalized_citizen") {
      c("mexico", "dominican republic", "cuba")
    } else {
      c("mexico", "puerto rico", "dominican republic", "cuba")
    }
    
    current_ivs <- if (dv == "less_than_primary_completed") {
      ivs[!ivs %in% "secondary_or_above"]
    } else {
      ivs
    }
    
    data_filtered <- data %>% 
      filter(country_string %in% current_countries) %>% 
      mutate(country_string = fct_relevel(country_string, "mexico"))
    
    formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }
  
  # extract country coefficients
  country_coefs <- map_dfr(names(results_list), function(dv) {
    tidy(results_list[[dv]]) %>%
      filter(str_detect(term, "country_string")) %>%
      mutate(outcome = dv,
             term = str_remove(term, "country_string"))
  }, .id = NULL) %>%
    pivot_wider(names_from = outcome, values_from = c(estimate, std.error, statistic, p.value)) %>%
    add_row(term = "mexico", .before = 1) %>%
    mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>%
    arrange(match(term, c("cuba", "dominican republic", "mexico", "puerto rico")))
  
  return(country_coefs)
}

# create all three versions
country_coefs <- create_country_coefs(us_df_2020)
male_country_coefs <- create_country_coefs(us_df_2020, sex_filter = 1)
female_country_coefs <- create_country_coefs(us_df_2020, sex_filter = 2)
```

## year of migration interaction (no controls)
in model of married, drop lives alone
in predicting naturalized citizen, drop PR
```{r}
dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", "is_naturalized_citizen", "less_than_primary_completed")
ivs <- c("country_string*year")  # corrected
results_list <- list()

# running the models
for (dv in dvs) {
  current_countries <- if (dv == "is_naturalized_citizen") {
    c("mexico", "dominican republic", "cuba")  # exclude when pr when dv is citizen
  } else {
    c("mexico", "puerto rico", "dominican republic", "cuba")
  }
  
  us_df_all_filtered <- us_df_all %>% 
    filter(country_string %in% current_countries) %>% 
    mutate(country_string = fct_relevel(country_string, "mexico"))
  
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))
  print(formula)
  model <- lm(formula, data = us_df_all_filtered, 
               weights = perwt)
  results_list[[dv]] <- model
}

summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/2020_US_model_summaries_no_controls_interaction.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}
```
# multivariate interaction
```{r}
dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", "is_naturalized_citizen", "less_than_primary_completed")
ivs <- c("age_at_immigration_15to24","age_at_immigration_25to49", "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "female", "country_string", "english_speaker", "secondary_or_above", "age_70to79", "age_80to89", "age_90plus", "country_string*year")
results_list <- list()

# running the models
for (dv in dvs) {
  # conditionally modify countries for filtering
  current_countries <- if (dv == "is_naturalized_citizen") {
    c("mexico", "dominican republic", "cuba")  # exclude when pr when dv is citizen
  } else {
    c("mexico", "puerto rico", "dominican republic", "cuba")
  }
  
  # conditionally modify ivs
  current_ivs <- if (dv == "less_than_primary_completed") {
    ivs[!ivs %in% "secondary_or_above"]
  } else {
    ivs
  }
  
  # filter data with conditional countries
  us_df_all_filtered <- us_df_all %>% 
    filter(country_string %in% current_countries) %>% 
    mutate(country_string = fct_relevel(country_string, "mexico"))
  
  formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
  print(formula)
  model <- lm(formula, data = us_df_all_filtered, 
               weights = perwt)
  results_list[[dv]] <- model
}

summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()
# Loop through each model in results_list
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/2020_US_model_summaries_all_controls_interaction.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}
```

## migrant regressions
```{r}
dvs <- c("cognitive_difficulty", "independent_living_difficulty")
ivs <- c("married_cohab", "age_at_immigration_25to49", "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "female",  "country_string", "lives_alone", "english_speaker", "secondary_or_above", "age_70to79", "age_80to89", "age_90plus")

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"))

results_list <- list()

# running the models
for (dv in dvs) {
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))
  print(formula)
  model <- lm(formula, data = us_df_2020_filtered,  # corrected data frame name
               weights = perwt)
  results_list[[dv]] <- model
}

current_ivs <- if (dv == "less_than_primary_completed") {
    ivs[!ivs %in% "secondary_or_above"]
  } else {
    ivs
  }

summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/within_US_model_summaries.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}

```
## overall DV emmeans
```{r}
emm_options(rg.limit = 70000)

emm_results <- map(results_list, ~ emmeans(.x, 
                                          specs = "country_string",
                                          at = list(married_cohab = 0,
                                                   age_at_immigration_under15 = 0,
                                                   age_at_immigration_25to49 = 0,
                                                   age_at_immigration_50plus = 0,
                                                   yrimm_before1965 = 0,
                                                   yrimm_1965to1980 = 0,
                                                   yrimm_1980to1999 = 0,
                                                   yrimm_2000plus = 0,
                                                   female = 0,
                                                   primary_or_above = 0,
                                                   is_naturalized_citizen = 0,
                                                   lives_alone = 0,
                                                   english_speaker = 0,
                                                   secondary_or_above = 0)))

# Convert to tidy data frames with CIs
emm_tables <- map(emm_results, ~ summary(.x, infer = TRUE) %>% 
                  as.data.frame() %>%
                  select(country_string, emmean, SE, lower.CL, upper.CL))

for (dv in dvs) {
  p <- ggplot(emm_tables[[dv]], 
            aes(x = factor(str_to_title(country_string), 
                          levels = c("Mexico", "Puerto Rico", "Dominican Republic", "Cuba")), 
                y = emmean,
                fill = country_string)) +
  geom_col(width = 0.7) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.2, color = "black") +
  scale_fill_manual(values = c(
    "mexico" = "#E69F00",
    "puerto rico" = "#56B4E9",
    "dominican republic" = "#009E73",
    "cuba" = "#CC79A7"
  )) +
  geom_text(
    aes(label = percent(emmean, accuracy = 1)),
    vjust = -1.5, 
    color = "black",
    size = 3.5,
    fontface = "bold"
  ) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.1))
  ) +
  ylim(0,1) +
  labs(
    title = str_to_title(str_replace_all(dv, "_", " ")),
    x = element_blank(),
    y = "Estimated Percent"
  ) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_blank(),
        legend.position = "none")

  
  print(p)
  
  ggsave(
    filename = file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots", 
                        paste0(dv, "_emm_plot.png")),
    plot = p,
    device = "png",
    width = 8,
    height = 6,
    dpi = 300
  )
}
```
# emmeans with only PR and MEX
```{r}
for (dv in dvs) {
  # filter to only mexico and puerto rico
  filtered_data <- emm_tables[[dv]] %>%
    filter(country_string %in% c("mexico", "puerto rico"))
  
  p <- ggplot(filtered_data, 
              aes(x = reorder(country_string, emmean), 
                  y = emmean)) +
    geom_col(fill = "#1f78b4", width = 0.7) +
    geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                  width = 0.2, color = "black") +
    geom_text(
      aes(label = percent(emmean, accuracy = 1)),
      vjust = -1.5, 
      color = "black",
      size = 3.5,
      fontface = "bold"
    ) +
    scale_y_continuous(
      labels = percent_format(accuracy = 1),
      expand = expansion(mult = c(0, 0.1))
    ) +
    ylim(0,1) +
    labs(
      title = str_to_title(str_replace_all(dv, "_", " ")),
      x = element_blank(),
      y = "Estimated Percent"
    ) +
    theme_cowplot() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.text.y = element_blank())
  
  print(p)
  
  ggsave(
    filename = file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots", 
                        paste0(dv, "_emm_plot_filtered.png")),
    plot = p,
    device = "png",
    width = 8,
    height = 6,
    dpi = 300
  )
}
```

# migrant-specific regressions
```{r}
dvs <- c("married_cohab", "age_at_immigration_under15", "age_at_immigration_15to49", "age_at_immigration_50plus", "secondary_or_above", "less_than_primary_completed", "primary_completed", "secondary_completed", "university_completed", "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "yrimm_2000plus", "is_naturalized_citizen", "female", "english_speaker")

ivs <- c("country_string", "age_70to79", "age_80to89")

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"))

results_list <- list()

# running the models
for (dv in dvs) {
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))

  print(formula)

  model <- glm(formula, data = us_df_2020_filtered, 
               family = binomial(),
               weights = perwt)

  results_list[[dv]] <- model
}

summaries <- map(results_list, summary)

for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()

# Loop through each model in results_list
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/within_US_model_summaries.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}
```
## age at migration correlated with education?
```{r}
run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + as.factor(english_speaker) + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_me <- run_education_model(us_df_2020, "primary_or_above", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "primary_or_above", "cuba")
primary_completed_model_pr <- run_education_model(us_df_2020, "primary_or_above", "puerto rico")
primary_completed_model_dr <- run_education_model(us_df_2020, "primary_or_above", "dominican republic")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, english_speaker = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, english_speaker = english_speaker, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_pr <- get_emmeans_summary(primary_completed_model_pr) %>% 
  mutate(country = "puerto rico")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_pr, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability of Primary Education or Above", 
       title = "Probability of Primary Education or Above by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_primary_education_by_immigration_age_and_country.png"), width = 12, height = 8)
```
## age at migration correlated with citizenship?
```{r}
primary_completed_model_me <- run_education_model(us_df_2020, "is_naturalized_citizen", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "is_naturalized_citizen", "cuba")
primary_completed_model_dr <- run_education_model(us_df_2020, "is_naturalized_citizen", "dominican republic")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, english_speaker = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, english_speaker = english_speaker, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability", 
       title = "Probability of Naturalized Citizen by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_citizen_by_immigration_age_and_country.png"), width = 12, height = 8)
```
## age at migration correlated with english speaking?
```{r}
run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + as.factor(is_naturalized_citizen) + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string" + "country_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_me <- run_education_model(us_df_2020, "english_speaker", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "english_speaker", "cuba")
primary_completed_model_dr <- run_education_model(us_df_2020, "english_speaker", "dominican republic")

run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_pr <- run_education_model(us_df_2020, "english_speaker", "puerto rico")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_pr <- get_emmeans_summary(primary_completed_model_pr) %>% 
  mutate(country = "puerto rico")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_pr, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability", 
       title = "Probability of Speaking English by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_english_speaking_by_immigration_age_and_country.png"), width = 12, height = 8)
```

