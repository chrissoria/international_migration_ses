---
title: "regressions"
author: "Chris Soria"
date: "2025-01-08"
output: html_document
---
#packages
```{r}
library(tidyverse)
library(broom)
library(cowplot)
library(writexl)
library(scales)
library(haven)
```
#prep
```{r}
target_dir <- normalizePath("C:/Users/Ty/Documents/GitHub/international_migration_ses/tables/r_tables")
current_dir <- "C:/Users/Ty/Documents/GitHub/international_migration_ses/tables/r_tables"

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots/")

} else {
  out_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/tables\r_tables")
  data_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/data")
  plot_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/plots")

}

print(getwd())

us_df_2010_filtered <- us_df_2010 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"),
          year = haven::as_factor(year)) %>% 
  select(married_cohab, age_at_immigration_15to24, age_at_immigration_25to49, age_at_immigration_50plus, 
         yrimm_before1965, yrimm_1965to1980, yrimm_1980to1999, female,  
         country_string, lives_alone, english_speaker, secondary_or_above, 
         age_70to79, age_80to89, age_90plus, perwt, year, is_naturalized_citizen, less_than_primary_completed, sex)

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"),
          year = haven::as_factor(year)) %>% 
  select(married_cohab, age_at_immigration_15to24, age_at_immigration_25to49, age_at_immigration_50plus, 
         yrimm_before1965, yrimm_1965to1980, yrimm_1980to1999, female,  
         country_string, lives_alone, english_speaker, secondary_or_above, 
         age_70to79, age_80to89, age_90plus, perwt, year, is_naturalized_citizen, less_than_primary_completed, sex)

us_df_all <- rbind(us_df_2010_filtered, us_df_2020_filtered)
```
# regressions
## no controls
```{r}
# function to create models by sex
create_models_by_sex <- function(data, sex_filter = NULL) {
  
  # apply sex filter if specified
  if (!is.null(sex_filter)) {
    data <- data %>% filter(sex == sex_filter)
    sex_label <- ifelse(sex_filter == 1, "male", "female")
  } else {
    sex_label <- "all"
  }
  
  dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
           "is_naturalized_citizen", "less_than_primary_completed")
  ivs <- c("country_string")
  results_list <- list()
  
  for (dv in dvs) {
    current_countries <- if (dv == "is_naturalized_citizen") {
      c("mexico", "dominican republic", "cuba")
    } else {
      c("mexico", "puerto rico", "dominican republic", "cuba")
    }
    
    data_filtered <- data %>% 
      filter(country_string %in% current_countries) %>% 
      mutate(country_string = fct_relevel(country_string, "mexico"))
    
    formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }
  
  # print summaries
  summaries <- map(results_list, summary)
  for (reason in names(summaries)) {
    cat("\n\n", "Summary for", reason, "(", sex_label, "):\n")
    print(summaries[[reason]])
  }
  
  # create excel data
  excel_data <- list()
  for (reason in names(results_list)) {
    if (!is.null(results_list[[reason]])) {
      model_summary <- tidy(results_list[[reason]])
      excel_data[[reason]] <- model_summary
    }
  }
  
  return(results_list)
}

# create all three versions
results_all_2020 <- create_models_by_sex(us_df_2020)
results_male_2020 <- create_models_by_sex(us_df_2020, sex_filter = 1)
results_female_2020 <- create_models_by_sex(us_df_2020, sex_filter = 2)

# create 2010 versions
results_all_2010 <- create_models_by_sex(us_df_2010)
results_male_2010 <- create_models_by_sex(us_df_2010, sex_filter = 1)
results_female_2010 <- create_models_by_sex(us_df_2010, sex_filter = 2)
```
## full multivariate
```{r}
# turn model creation into a function
create_country_coefs <- function(data, sex_filter = NULL) {
  
  # apply sex filter if specified
  if (!is.null(sex_filter)) {
    data <- data %>% filter(sex == sex_filter)
  }
  
  dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
           "is_naturalized_citizen", "less_than_primary_completed")
  ivs <- c("country_string", "age_at_immigration_15to24","age_at_immigration_25to49", 
           "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", 
           "yrimm_1980to1999", "female",
           "age_70to79", "age_80to89", "age_90plus")
  results_list <- list()
  
  for (dv in dvs) {
    current_countries <- if (dv == "is_naturalized_citizen") {
      c("mexico", "dominican republic", "cuba")
    } else {
      c("mexico", "puerto rico", "dominican republic", "cuba")
    }
    
    current_ivs <- if (dv == "less_than_primary_completed") {
      ivs[!ivs %in% "secondary_or_above"]
    } else {
      ivs
    }
    
    data_filtered <- data %>% 
      filter(country_string %in% current_countries) %>% 
      mutate(country_string = fct_relevel(country_string, "mexico"))
    
    formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }
  
  summaries <- map(results_list, summary)
  for (reason in names(summaries)) {
    cat("\n\n", "Summary for", reason, ":\n")
    print(summaries[[reason]])
  }
  
  return(results_list)
}

# create all three versions
country_coefs_2020 <- create_country_coefs(us_df_2020)
male_country_coefs_2020 <- create_country_coefs(us_df_2020, sex_filter = 1)
female_country_coefs_2020 <- create_country_coefs(us_df_2020, sex_filter = 2)

country_coefs_2010 <- create_country_coefs(us_df_2010)
male_country_coefs_2010 <- create_country_coefs(us_df_2010, sex_filter = 1)
female_country_coefs_2010 <- create_country_coefs(us_df_2010, sex_filter = 2)
```
## table output
### 2020
```{r}
# generate excel output for each dv
dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
         "is_naturalized_citizen", "less_than_primary_completed")

# renaming mapping
term_labels <- c(
  country_stringcuba = "Cuba",
  country_stringdominican.republic = "Dominican Republic",
  country_stringpuerto.rico = "Puerto Rico",
  age_at_immigration_15to24 = "Immigrated Age 15-24",
  age_at_immigration_25to49 = "Immigrated Age 25-49",
  age_at_immigration_50plus = "Immigrated Age 50+",
  yrimm_before1965 = "Immigrated Before 1965",
  yrimm_1965to1980 = "Immigrated 1965-1980",
  yrimm_1980to1999 = "Immigrated 1980-1999",
  female = "Female",
  age_70to79 = "Age 70-79",
  age_80to89 = "Age 80-89",
  age_90plus = "Age 90+"
)

for (dv in dvs) {
  m1 <- tidy(results_all_2020[[dv]]) %>% mutate(model = "Unadjusted")
  m2 <- tidy(country_coefs_2020[[dv]]) %>% mutate(model = "Adjusted")
  m3 <- tidy(results_female_2020[[dv]]) %>% mutate(model = "Unadjusted (Females Only)")
  m4 <- tidy(female_country_coefs_2020[[dv]]) %>% mutate(model = "Adjusted (Females Only)")
  m5 <- tidy(results_male_2020[[dv]]) %>% mutate(model = "Unadjusted (Males Only)")
  m6 <- tidy(male_country_coefs_2020[[dv]]) %>% mutate(model = "Adjusted (Males Only)")
  
  combined <- bind_rows(m1, m2, m3, m4, m5, m6) %>%
    mutate(
      term = term_labels[make.names(term)],
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.10 ~ "*",
        TRUE ~ ""
      ),
      coef_se = paste0(round(estimate, 3), stars, "\n(", round(std.error, 3), ")")
    ) %>%
    select(term, model, coef_se) %>%
    pivot_wider(names_from = model, values_from = coef_se)
  
  # add n and r-squared rows
  model_stats <- tibble(
    model = c("Unadjusted", "Adjusted", "Unadjusted (Females Only)", 
              "Adjusted (Females Only)", "Unadjusted (Males Only)", "Adjusted (Males Only)"),
    n = c(nobs(results_all_2020[[dv]]), nobs(country_coefs_2020[[dv]]),
          nobs(results_female_2020[[dv]]), nobs(female_country_coefs_2020[[dv]]),
          nobs(results_male_2020[[dv]]), nobs(male_country_coefs_2020[[dv]])),
    r2 = c(glance(results_all_2020[[dv]])$r.squared, glance(country_coefs_2020[[dv]])$r.squared,
           glance(results_female_2020[[dv]])$r.squared, glance(female_country_coefs_2020[[dv]])$r.squared,
           glance(results_male_2020[[dv]])$r.squared, glance(male_country_coefs_2020[[dv]])$r.squared)
  )
  
  n_row <- model_stats %>%
    mutate(stat = as.character(n)) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "N", .before = 1)
  
  r2_row <- model_stats %>%
    mutate(stat = as.character(round(r2, 3))) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "R-squared", .before = 1)
  
  combined <- bind_rows(combined, n_row, r2_row)
  
  write_xlsx(combined, 
    path = paste0(out_dir, "../regressions/", dv, "_models_2020.xlsx"))
}

```

###2010
```{r}
for (dv in dvs) {
  m1 <- tidy(results_all_2010[[dv]]) %>% mutate(model = "Unadjusted")
  m2 <- tidy(country_coefs_2010[[dv]]) %>% mutate(model = "Adjusted")
  m3 <- tidy(results_female_2010[[dv]]) %>% mutate(model = "Unadjusted (Females Only)")
  m4 <- tidy(female_country_coefs_2010[[dv]]) %>% mutate(model = "Adjusted (Females Only)")
  m5 <- tidy(results_male_2010[[dv]]) %>% mutate(model = "Unadjusted (Males Only)")
  m6 <- tidy(male_country_coefs_2010[[dv]]) %>% mutate(model = "Adjusted (Males Only)")
  
  combined <- bind_rows(m1, m2, m3, m4, m5, m6) %>%
    mutate(
      term = term_labels[make.names(term)],
      stars = case_when(
        p.value < 0.01 ~ "***",
        p.value < 0.05 ~ "**",
        p.value < 0.10 ~ "*",
        TRUE ~ ""
      ),
      coef_se = paste0(round(estimate, 3), stars, "\n(", round(std.error, 3), ")")
    ) %>%
    select(term, model, coef_se) %>%
    pivot_wider(names_from = model, values_from = coef_se)
  
  # add n and r-squared rows
  model_stats <- tibble(
    model = c("Unadjusted", "Adjusted", "Unadjusted (Females Only)", 
              "Adjusted (Females Only)", "Unadjusted (Males Only)", "Adjusted (Males Only)"),
    n = c(nobs(results_all_2010[[dv]]), nobs(country_coefs_2010[[dv]]),
          nobs(results_female_2010[[dv]]), nobs(female_country_coefs_2010[[dv]]),
          nobs(results_male_2010[[dv]]), nobs(male_country_coefs_2010[[dv]])),
    r2 = c(glance(results_all_2010[[dv]])$r.squared, glance(country_coefs_2010[[dv]])$r.squared,
           glance(results_female_2010[[dv]])$r.squared, glance(female_country_coefs_2010[[dv]])$r.squared,
           glance(results_male_2010[[dv]])$r.squared, glance(male_country_coefs_2010[[dv]])$r.squared)
  )
  
  n_row <- model_stats %>%
    mutate(stat = as.character(n)) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "N", .before = 1)
  
  r2_row <- model_stats %>%
    mutate(stat = as.character(round(r2, 3))) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "R-squared", .before = 1)
  
  combined <- bind_rows(combined, n_row, r2_row)
  
  write_xlsx(combined, 
    path = paste0(out_dir, "../regressions/", dv, "_models_2010.xlsx"))
}
```

# year of migration interaction
## univariate
```{r}
# turn model creation into a function
create_country_coefs <- function(data, sex_filter = NULL) {
  
  # apply sex filter if specified
  if (!is.null(sex_filter)) {
    data <- data %>% filter(sex == sex_filter)
  }
  
  dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
           "is_naturalized_citizen", "less_than_primary_completed")
  ivs <- c("country_string*year")
  results_list <- list()
  
  for (dv in dvs) {
    current_countries <- if (dv == "is_naturalized_citizen") {
      c("mexico", "dominican republic", "cuba")
    } else {
      c("mexico", "puerto rico", "dominican republic", "cuba")
    }
    
    current_ivs <- if (dv == "less_than_primary_completed") {
      ivs[!ivs %in% "secondary_or_above"]
    } else {
      ivs
    }
    
    data_filtered <- data %>% 
      filter(country_string %in% current_countries) %>% 
      mutate(country_string = fct_relevel(country_string, "mexico"))
    
    formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }
  
  summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}
  
  # extract country coefficients
  country_coefs <- map_dfr(names(results_list), function(dv) {
    tidy(results_list[[dv]]) %>%
      filter(str_detect(term, "year2020")) %>%
      mutate(outcome = dv,
             term = str_remove(term, "country_string"),
             term = str_remove(term, ":year2020"))
  }, .id = NULL) %>%
    pivot_wider(names_from = outcome, values_from = c(estimate, std.error, statistic, p.value)) %>%
    arrange(match(term, c("country_stringcuba:year2020", "country_stringdominican republic:year2020", "mexico", "country_stringpuerto rico:year2020")))
  
  return(country_coefs)
}

# check if excel_data exists and is not empty
if (exists("excel_data") && length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/2020_US_model_summaries_no_controls_interaction.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}

# create all three versions
country_coefs_interaction_no_cont <- create_country_coefs(us_df_all) %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "mean_{.col}"
    )
  )

male_country_coefs_interaction_no_cont <- create_country_coefs(us_df_all, sex_filter = 1) %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "mean_{.col}"
    )
  )

female_country_coefs_interaction_no_cont <- create_country_coefs(us_df_all, sex_filter = 2) %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "mean_{.col}"
    )
  )
```
## multivariate interaction
```{r}
# turn model creation into a function
create_country_coefs <- function(data, sex_filter = NULL) {
  
  # apply sex filter if specified
  if (!is.null(sex_filter)) {
    data <- data %>% filter(sex == sex_filter)
  }
  
  dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
           "is_naturalized_citizen", "less_than_primary_completed")
  ivs <- c("country_string*year", "age_at_immigration_15to24","age_at_immigration_25to49", 
           "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", 
           "yrimm_1980to1999", "female",
           "age_70to79", "age_80to89", "age_90plus")
  results_list <- list()
  
  for (dv in dvs) {
    current_countries <- if (dv == "is_naturalized_citizen") {
      c("mexico", "dominican republic", "cuba")
    } else {
      c("mexico", "puerto rico", "dominican republic", "cuba")
    }
    
    current_ivs <- if (dv == "less_than_primary_completed") {
      ivs[!ivs %in% "secondary_or_above"]
    } else {
      ivs
    }
    
    data_filtered <- data %>% 
      filter(country_string %in% current_countries) %>% 
      mutate(country_string = fct_relevel(country_string, "mexico"))
    
    formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }
  
  summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}
  
  # extract country coefficients
  country_coefs <- map_dfr(names(results_list), function(dv) {
    tidy(results_list[[dv]]) %>%
      filter(str_detect(term, "year2020")) %>%
      mutate(outcome = dv,
             term = str_remove(term, "country_string"),
             term = str_remove(term, ":year2020"))
  }, .id = NULL) %>%
    pivot_wider(names_from = outcome, values_from = c(estimate, std.error, statistic, p.value)) %>%
    arrange(match(term, c("country_stringcuba:year2020", "country_stringdominican republic:year2020", "mexico", "country_stringpuerto rico:year2020")))
  
  return(country_coefs)
}

# check if excel_data exists and is not empty
if (exists("excel_data") && length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/2020_US_model_summaries_all_controls_interaction.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}

# create all three versions
country_coefs_interaction <- create_country_coefs(us_df_all) %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "adjusted_mean_{.col}"
    )
  )
male_country_coefs_interaction <- create_country_coefs(us_df_all, sex_filter = 1)  %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "adjusted_mean_{.col}"
    )
  )
female_country_coefs_interaction <- create_country_coefs(us_df_all, sex_filter = 2)  %>% 
  mutate(
    term = case_when(
      term == "year2020" ~ "mexico",
      TRUE ~ term
    )
  ) %>%
  mutate(
    across(
      starts_with("estimate_"),
      ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
      .names = "adjusted_mean_{.col}"
    )
  )
```
##table output
###all interactions
```{r}
# function to create interaction model tables
create_interaction_tables <- function(results_list_unadj, results_list_adj, 
                                     results_list_female_unadj, results_list_female_adj,
                                     results_list_male_unadj, results_list_male_adj, 
                                     dvs, output_prefix) {
  
  for (dv in dvs) {
    m1 <- tidy(results_list_unadj[[dv]]) %>% mutate(model = "Unadjusted")
    m2 <- tidy(results_list_adj[[dv]]) %>% mutate(model = "Adjusted")
    m3 <- tidy(results_list_female_unadj[[dv]]) %>% mutate(model = "Unadjusted (Females Only)")
    m4 <- tidy(results_list_female_adj[[dv]]) %>% mutate(model = "Adjusted (Females Only)")
    m5 <- tidy(results_list_male_unadj[[dv]]) %>% mutate(model = "Unadjusted (Males Only)")
    m6 <- tidy(results_list_male_adj[[dv]]) %>% mutate(model = "Adjusted (Males Only)")
    
    combined <- bind_rows(m1, m2, m3, m4, m5, m6) %>%
      filter(str_detect(term, ":year2020")) %>%
      mutate(
        term = str_remove(term, "country_string"),
        term = str_remove(term, ":year2020")
      ) %>%
      mutate(
        term = term_labels_interaction[term],
        stars = case_when(
          p.value < 0.01 ~ "***",
          p.value < 0.05 ~ "**",
          p.value < 0.10 ~ "*",
          TRUE ~ ""
        ),
        coef_se = paste0(round(estimate, 3), stars, "\n(", round(std.error, 3), ")")
      ) %>%
      select(term, model, coef_se) %>%
      filter(!is.na(term)) %>%
      pivot_wider(names_from = model, values_from = coef_se)
    
    # add n and r-squared rows
    model_stats <- tibble(
      model = c("Unadjusted", "Adjusted", "Unadjusted (Females Only)", 
                "Adjusted (Females Only)", "Unadjusted (Males Only)", "Adjusted (Males Only)"),
      n = c(nobs(results_list_unadj[[dv]]), nobs(results_list_adj[[dv]]),
            nobs(results_list_female_unadj[[dv]]), nobs(results_list_female_adj[[dv]]),
            nobs(results_list_male_unadj[[dv]]), nobs(results_list_male_adj[[dv]])),
      r2 = c(glance(results_list_unadj[[dv]])$r.squared, glance(results_list_adj[[dv]])$r.squared,
             glance(results_list_female_unadj[[dv]])$r.squared, glance(results_list_female_adj[[dv]])$r.squared,
             glance(results_list_male_unadj[[dv]])$r.squared, glance(results_list_male_adj[[dv]])$r.squared)
    )
    
    n_row <- model_stats %>%
      mutate(stat = as.character(n)) %>%
      select(model, stat) %>%
      pivot_wider(names_from = model, values_from = stat) %>%
      mutate(term = "N", .before = 1)
    
    r2_row <- model_stats %>%
      mutate(stat = as.character(round(r2, 3))) %>%
      select(model, stat) %>%
      pivot_wider(names_from = model, values_from = stat) %>%
      mutate(term = "R-squared", .before = 1)
    
    combined <- bind_rows(combined, n_row, r2_row)
    
    write_xlsx(combined, 
      path = paste0(out_dir, "../regressions/", output_prefix, "_", dv, "_interaction.xlsx"))
  }
}

results_interaction_unadj <- create_country_coefs_full(us_df_all, include_controls = FALSE)
results_interaction_adj <- create_country_coefs_full(us_df_all, include_controls = TRUE)
results_female_interaction_unadj <- create_country_coefs_full(us_df_all, sex_filter = 2, include_controls = FALSE)
results_female_interaction_adj <- create_country_coefs_full(us_df_all, sex_filter = 2, include_controls = TRUE)
results_male_interaction_unadj <- create_country_coefs_full(us_df_all, sex_filter = 1, include_controls = FALSE)
results_male_interaction_adj <- create_country_coefs_full(us_df_all, sex_filter = 1, include_controls = TRUE)

dvs <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above", 
         "is_naturalized_citizen", "less_than_primary_completed")

create_interaction_tables(
  results_interaction_unadj, 
  results_interaction_adj,
  results_female_interaction_unadj, 
  results_female_interaction_adj,
  results_male_interaction_unadj, 
  results_male_interaction_adj,
  dvs, 
  "interaction_models"
)
```

## migrant regressions
```{r}
dvs <- c("cognitive_difficulty", "independent_living_difficulty")
ivs <- c("married_cohab", "age_at_immigration_25to49", "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "female",  "country_string", "lives_alone", "english_speaker", "secondary_or_above", "age_70to79", "age_80to89", "age_90plus")

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"))

results_list <- list()

# running the models
for (dv in dvs) {
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))
  print(formula)
  model <- lm(formula, data = us_df_2020_filtered,  # corrected data frame name
               weights = perwt)
  results_list[[dv]] <- model
}

current_ivs <- if (dv == "less_than_primary_completed") {
    ivs[!ivs %in% "secondary_or_above"]
  } else {
    ivs
  }

summaries <- map(results_list, summary)
for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/within_US_model_summaries.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}

```
## overall DV emmeans
```{r}
emm_options(rg.limit = 70000)

emm_results <- map(results_list, ~ emmeans(.x, 
                                          specs = "country_string",
                                          at = list(married_cohab = 0,
                                                   age_at_immigration_under15 = 0,
                                                   age_at_immigration_25to49 = 0,
                                                   age_at_immigration_50plus = 0,
                                                   yrimm_before1965 = 0,
                                                   yrimm_1965to1980 = 0,
                                                   yrimm_1980to1999 = 0,
                                                   yrimm_2000plus = 0,
                                                   female = 0,
                                                   primary_or_above = 0,
                                                   is_naturalized_citizen = 0,
                                                   lives_alone = 0,
                                                   english_speaker = 0,
                                                   secondary_or_above = 0)))

# Convert to tidy data frames with CIs
emm_tables <- map(emm_results, ~ summary(.x, infer = TRUE) %>% 
                  as.data.frame() %>%
                  select(country_string, emmean, SE, lower.CL, upper.CL))

for (dv in dvs) {
  p <- ggplot(emm_tables[[dv]], 
            aes(x = factor(str_to_title(country_string), 
                          levels = c("Mexico", "Puerto Rico", "Dominican Republic", "Cuba")), 
                y = emmean,
                fill = country_string)) +
  geom_col(width = 0.7) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.2, color = "black") +
  scale_fill_manual(values = c(
    "mexico" = "#E69F00",
    "puerto rico" = "#56B4E9",
    "dominican republic" = "#009E73",
    "cuba" = "#CC79A7"
  )) +
  geom_text(
    aes(label = percent(emmean, accuracy = 1)),
    vjust = -1.5, 
    color = "black",
    size = 3.5,
    fontface = "bold"
  ) +
  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    expand = expansion(mult = c(0, 0.1))
  ) +
  ylim(0,1) +
  labs(
    title = str_to_title(str_replace_all(dv, "_", " ")),
    x = element_blank(),
    y = "Estimated Percent"
  ) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_blank(),
        legend.position = "none")

  
  print(p)
  
  ggsave(
    filename = file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots", 
                        paste0(dv, "_emm_plot.png")),
    plot = p,
    device = "png",
    width = 8,
    height = 6,
    dpi = 300
  )
}
```
# emmeans with only PR and MEX
```{r}
for (dv in dvs) {
  # filter to only mexico and puerto rico
  filtered_data <- emm_tables[[dv]] %>%
    filter(country_string %in% c("mexico", "puerto rico"))
  
  p <- ggplot(filtered_data, 
              aes(x = reorder(country_string, emmean), 
                  y = emmean)) +
    geom_col(fill = "#1f78b4", width = 0.7) +
    geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                  width = 0.2, color = "black") +
    geom_text(
      aes(label = percent(emmean, accuracy = 1)),
      vjust = -1.5, 
      color = "black",
      size = 3.5,
      fontface = "bold"
    ) +
    scale_y_continuous(
      labels = percent_format(accuracy = 1),
      expand = expansion(mult = c(0, 0.1))
    ) +
    ylim(0,1) +
    labs(
      title = str_to_title(str_replace_all(dv, "_", " ")),
      x = element_blank(),
      y = "Estimated Percent"
    ) +
    theme_cowplot() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.text.y = element_blank())
  
  print(p)
  
  ggsave(
    filename = file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots", 
                        paste0(dv, "_emm_plot_filtered.png")),
    plot = p,
    device = "png",
    width = 8,
    height = 6,
    dpi = 300
  )
}
```

# migrant-specific regressions
```{r}
dvs <- c("married_cohab", "age_at_immigration_under15", "age_at_immigration_15to49", "age_at_immigration_50plus", "secondary_or_above", "less_than_primary_completed", "primary_completed", "secondary_completed", "university_completed", "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "yrimm_2000plus", "is_naturalized_citizen", "female", "english_speaker")

ivs <- c("country_string", "age_70to79", "age_80to89")

us_df_2020_filtered <- us_df_2020 %>% 
   filter(country_string %in% c("mexico", "puerto rico", "dominican republic", "cuba")) %>% 
   mutate(country_string = fct_relevel(country_string, "mexico"))

results_list <- list()

# running the models
for (dv in dvs) {
  formula <- as.formula(paste(dv, "~", paste(ivs, collapse = " + ")))

  print(formula)

  model <- glm(formula, data = us_df_2020_filtered, 
               family = binomial(),
               weights = perwt)

  results_list[[dv]] <- model
}

summaries <- map(results_list, summary)

for (reason in names(summaries)) {
  cat("\n\n", "Summary for", reason, ":\n")
  print(summaries[[reason]])
}

excel_data <- list()

# Loop through each model in results_list
for (reason in names(results_list)) {
  if (!is.null(results_list[[reason]])) {
    model_summary <- tidy(results_list[[reason]])
    
    excel_data[[reason]] <- model_summary
  } else {
    cat("\n\n", "No valid model for", reason, "\n")
  }
}

if (length(excel_data) > 0) {
  write_xlsx(excel_data, path = paste0(out_dir, "../regressions/within_US_model_summaries.xlsx"))
} else {
  cat("No valid data to write to Excel.\n")
}
```
## age at migration correlated with education?
```{r}
run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + as.factor(english_speaker) + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_me <- run_education_model(us_df_2020, "primary_or_above", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "primary_or_above", "cuba")
primary_completed_model_pr <- run_education_model(us_df_2020, "primary_or_above", "puerto rico")
primary_completed_model_dr <- run_education_model(us_df_2020, "primary_or_above", "dominican republic")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, english_speaker = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, english_speaker = english_speaker, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_pr <- get_emmeans_summary(primary_completed_model_pr) %>% 
  mutate(country = "puerto rico")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_pr, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability of Primary Education or Above", 
       title = "Probability of Primary Education or Above by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_primary_education_by_immigration_age_and_country.png"), width = 12, height = 8)
```
## age at migration correlated with citizenship?
```{r}
primary_completed_model_me <- run_education_model(us_df_2020, "is_naturalized_citizen", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "is_naturalized_citizen", "cuba")
primary_completed_model_dr <- run_education_model(us_df_2020, "is_naturalized_citizen", "dominican republic")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, english_speaker = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, english_speaker = english_speaker, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability", 
       title = "Probability of Naturalized Citizen by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_citizen_by_immigration_age_and_country.png"), width = 12, height = 8)
```
## age at migration correlated with english speaking?
```{r}
run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + as.factor(is_naturalized_citizen) + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string" + "country_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_me <- run_education_model(us_df_2020, "english_speaker", "mexico")
primary_completed_model_cu <- run_education_model(us_df_2020, "english_speaker", "cuba")
primary_completed_model_dr <- run_education_model(us_df_2020, "english_speaker", "dominican republic")

run_education_model <- function(data, dv, country) {
  model <- data %>%
    filter(country_string == country) %>%
    glm(as.formula(paste(dv, "~ age + as.factor(female) + race_string + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string")), 
        data = ., 
        family = binomial(),
        weights = perwt)
  
  return(model)
}

primary_completed_model_pr <- run_education_model(us_df_2020, "english_speaker", "puerto rico")

summary(primary_completed_model_me)

get_emmeans_summary <- function(model, specs = "age_at_immig_groups_string", age = 65, female = 1, race_string = "white hispanic", year_of_immig_groups_string = "1980 - 1999") {
  emm <- emmeans(model, 
                 specs = specs,
                 at = list(age = age, female = female, race_string = race_string, year_of_immig_groups_string = year_of_immig_groups_string),
                 type = "response")
  
  emm_summary <- transform(summary(emm))
  
  return(emm_summary)
}

emm_primary_completed_model_me <- get_emmeans_summary(primary_completed_model_me) %>% 
  mutate(country = "mexico")
emm_primary_completed_model_cu <- get_emmeans_summary(primary_completed_model_cu) %>% 
  mutate(country = "cuba")
emm_primary_completed_model_pr <- get_emmeans_summary(primary_completed_model_pr) %>% 
  mutate(country = "puerto rico")
emm_primary_completed_model_dr <- get_emmeans_summary(primary_completed_model_dr) %>% 
  mutate(country = "dominican republic")

all_emms_full_controls <- rbind(emm_primary_completed_model_me, emm_primary_completed_model_cu, emm_primary_completed_model_pr, emm_primary_completed_model_dr)

print(all_emms_full_controls)

ggplot(all_emms_full_controls, aes(x = age_at_immig_groups_string, y = prob, color = country, group = country)) +
  geom_point(position = position_dodge(width = 0.2)) +
  geom_line(position = position_dodge(width = 0.2)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.1, position = position_dodge(width = 0.2)) +
  labs(x = "Age at Immigration", y = "Probability", 
       title = "Probability of Speaking English by Age at Immigration and Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

ggsave(paste0(plot_dir, "predicted_english_speaking_by_immigration_age_and_country.png"), width = 12, height = 8)
```

