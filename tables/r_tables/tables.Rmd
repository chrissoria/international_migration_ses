---
title: "tables"
author: "Chris Soria"
date: "2024-09-28"
output: html_document
---

```{r}
library(haven)
library(tidyverse)
library(xtable)
library(kableExtra)
library(readxl)
library(officer)
```

```{r}
target_dir <- normalizePath("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables")
current_dir <- normalizePath(getwd())

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses//plots/")

} else {
  out_dir <- file.path("C:/Users/Ty/Desktop/ses_international/tables/r_tables//")
  data_dir <- file.path("C:/Users/Ty/Desktop/ses_international/data//")
  plot_dir <- file.path("C:/Users/Ty/Desktop/ses_international/plots//")

}

print(getwd())
```
## reading in data
```{r}
us_df_2010 <- read_dta(paste0(data_dir, "US_2010_v100.dta"))
us_df_2020 <- read_dta(paste0(data_dir, "US_2020_v100.dta"))
gdp <- read_excel(paste0(data_dir, "gdp_per_capita.xlsx"))

gdp <- gdp %>%
  filter(...1 %in% c("Cuba", "Dominican Republic", "Puerto Rico", "Mexico", "United States")) %>% 
  mutate(`2023` = if_else(...1 == "Cuba", "7449.68", `2023`)) %>% #cuba gdp per capita is 2022
  rename(gdp = `2023`,
         country = ...1)

#life expectancy at 60  
e60 <- read_csv(paste0(data_dir, "e60.csv"))
e60 <- e60 %>% 
  filter((Location %in% c("Cuba", "Dominican Republic", "Puerto Rico", "Mexico") & Period == 2010 & Indicator == "Life expectancy at age 60 (years)"))

e60_both_sexes <- e60 %>% 
  filter(Dim1 == "Both sexes")
  
e60_males <- e60 %>% 
  filter(Dim1 == "Male")

e60_females <- e60 %>% 
  filter(Dim1 == "Female")

#infant mortality rates
ifr_path <- paste0(data_dir, "IFR")
ifr_files <- list.files(path = ifr_path, pattern = "*.csv", full.names = TRUE, ignore.case = TRUE)

ifr_dfs <- lapply(ifr_files, function(file) {
  tryCatch({
    read_csv(file, col_types = cols(.default = "c"))  # Read all columns as character initially
  }, error = function(e) {
    warning(paste("Error reading file:", file, "-", e$message))
    return(NULL)
  })
})

names(ifr_dfs) <- basename(ifr_files)
ifr_dfs <- ifr_dfs[!sapply(ifr_dfs, is.null)]  # Remove any NULL entries (failed reads)

ifr_dfs <- lapply(names(ifr_dfs), function(name) {
  df <- ifr_dfs[[name]]
  df %>% 
    mutate(
      df_name = name,
      Int. = as.numeric(Int.),
      `Ref. date` = as.numeric(`Ref. date`)
    ) %>% 
    filter(`Ref. date` == 2010)
})

ifr_df <- bind_rows(ifr_dfs) %>% 
  filter(!is.na(`Std. err`) & Name == "VR Submitted to WHO/UNIGME 2023 version (VR)") %>% 
  filter(!df_name %in% c("COL-Infant mortality rate-Total-datasources-download.csv", 
                           "GTM-Infant mortality rate-Total-datasources-download.csv",
                           "HND-Infant mortality rate-Total-datasources-download.csv",
                           "SLV-Infant mortality rate-Total-datasources-download.csv"))

rm(ifr_path, ifr_files)

#US census
us_df <- us_df %>%
  mutate(bplcountry = as_factor(bplcountry)) %>% 
  mutate(race_native_category = as_factor(race_native_category))

#international censuses
in_df <- read_dta(paste0(data_dir,"CuDrMePrUs_10_12.dta"))

in_df <- in_df %>%
  mutate(country_year_bpl = as_factor(country_year_bpl))
```

table1, featuring Hispanic in their native countries
```{r}
create_table_for_sex_international <- function(sex_value) {
  in_df %>%
    filter(sex == sex_value) %>%
    group_by(country_year) %>%
    summarise(
    mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
    mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
    mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
    mean_married_cohab = weighted.mean(married_cohab, perwt_age_standardized, na.rm = TRUE),
    mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_primary_completed = weighted.mean(primary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_secondary_completed = weighted.mean(secondary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_university_completed = weighted.mean(university_completed, perwt_age_standardized, na.rm = TRUE),
    count = n()
    ) %>%
    pivot_longer(cols = -country_year, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = country_year, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "Age 60 - 69",
      mean_age_70_79 = "Age 70 - 79",
      mean_age_80_89 = "Age 80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_education_unknown = "Unknown"
    ))
}

table1_sex_1 <- create_table_for_sex_international(1)
table1_sex_2 <- create_table_for_sex_international(2)

combined_table1 <- bind_rows(
  table1_sex_2, #females first
  table1_sex_1 #males second
)

combined_table1 <- combined_table1 %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  mutate(Gender = ifelse(row_number() == 1, "Women", 
                         ifelse(row_number() == 10, "Men", ""))) %>%
                         
  select(Gender, everything()) %>% 
  rename(Demographics = variable) 

print(combined_table1)

#adding in the US born counterparts
create_table_for_sex_international <- function(sex_value) {
  in_df %>%
    filter(sex == sex_value) %>%
    group_by(country_year_bpl) %>%
    summarise(
    mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
    mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
    mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
    mean_married_cohab = weighted.mean(married_cohab, perwt_age_standardized, na.rm = TRUE),
    mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_primary_completed = weighted.mean(primary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_secondary_completed = weighted.mean(secondary_completed, perwt_age_standardized, na.rm = TRUE),
    mean_university_completed = weighted.mean(university_completed, perwt_age_standardized, na.rm = TRUE),
    count = n()
    ) %>%
    pivot_longer(cols = -country_year_bpl, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = country_year_bpl, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "Age 60 - 69",
      mean_age_70_79 = "Age 70 - 79",
      mean_age_80_89 = "Age 80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_education_unknown = "Unknown"
    ))
}

table1_sex_1_us <- create_table_for_sex_us_counterparts(1)
table1_sex_2_us <- create_table_for_sex_us_counterparts(2)

combined_table2 <- bind_rows(
  table1_sex_2_us, #females first
  table1_sex_1_us #males second
)

combined_table2 <- combined_table2 %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  select(-variable) 

combined_table1 <- cbind(combined_table1, combined_table2) %>% 
  rename(`US Mexican-born` = mexico,
         `US Puerto-Rican-born` = `puerto rico`,
         `US Dominican-born` = `dominican republic`,
         `US Cuban-born` = cuba,
         `Cubans`  = Cuba_2012,
         `Dominicans`  = DR_2010,
         `Dominicans`  = DR_2010,
         `Mexicans`  = Mexico_2010,
         `Puerto Ricans`  = PR_2010,
         `All US Residents` = US_2010
         ) %>%
  select(
    Gender, Demographics,
    `Mexicans`, `US Mexican-born`, 
    `Puerto Ricans`, `US Puerto-Rican-born`,
    `Dominicans`, `US Dominican-born`,
    `Cubans`, `US Cuban-born`
  )

print(combined_table1)

table_md <- kbl(combined_table1, format = "markdown", label = "tab:table1", caption = "Summary Table") %>%
  kable_styling(latex_options = "scale=1.2")

writeLines(as.character(table_md), paste0(out_dir,"table1.tex"))

table1_code <- xtable(combined_table1, caption = "Summary Statistics by Country and Sex For Hispanics in Their Native Countries", 
                      align = "ll|l|llllllll")


sink(paste0(out_dir,"table1.tex"))
print(table1_code, type = "latex", 
      caption.placement = "top",
      #size = "//small",
      include.rownames = FALSE)

sink()
```
table2, consolidated genders
```{r}
# create a group that has a weird age
# move baseline vars up top
table2_consolidated <- us_df_2020 %>%
    filter(country_string == "mexico" | 
       country_string == "puerto rico" | 
       country_string == "dominican republic" |
       country_string == "cuba") %>% 
    group_by(country_string) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_age_at_immigration_15 = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      mean_age_at_immigration_15to49 = weighted.mean(age_at_immigration_15to49, perwt, na.rm = TRUE),
      mean_age_at_immigration_50plus = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE),
      mean_yrimm_before1965 = weighted.mean(yrimm_before1965, perwt, na.rm = TRUE),
      mean_yrimm_1965_1979 = weighted.mean(yrimm_1965to1980, perwt, na.rm = TRUE),
      mean_yrimm_1980_1999 = weighted.mean(yrimm_1980to1999, perwt, na.rm = TRUE),
      mean_yrimm_2000plus = weighted.mean(yrimm_2000plus, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_naturalized_citizen, perwt, na.rm = TRUE),
      mean_female = weighted.mean(female, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      N = n()
    ) %>%
    pivot_longer(cols = -country_string, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = country_string, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "60 - 69",
      mean_age_70_79 = "70 - 79",
      mean_age_80_89 = "80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_female = "Female",
      mean_english_speaker = "English Speakers",
      mean_is_citizen = "Citizen",
      mean_age_at_immigration_15 = "Less than 15",
      mean_age_at_immigration_15to49 = "15 - 49",
      mean_age_at_immigration_50plus = "Greater than 50",
      mean_years_in_us = "Years in US",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_yrimm_before1965 = "Before 1965",
      mean_yrimm_1965_1979 = "1965 - 1979",
      mean_yrimm_1980_1999 = "1980 - 1999",
      mean_yrimm_2000plus = "After 2000"
    ))

print(table2_consolidated)

table2_consolidated_migrant <- us_df_2020 %>%
    group_by(hispanic_migrant_status) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_age_at_immigration_15 = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      mean_age_at_immigration_15to49 = weighted.mean(age_at_immigration_15to49, perwt, na.rm = TRUE),
      mean_age_at_immigration_50plus = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE),
      mean_yrimm_before1965 = weighted.mean(yrimm_before1965, perwt, na.rm = TRUE),
      mean_yrimm_1965_1979 = weighted.mean(yrimm_1965to1980, perwt, na.rm = TRUE),
      mean_yrimm_1980_1999 = weighted.mean(yrimm_1980to1999, perwt, na.rm = TRUE),
      mean_yrimm_2000plus = weighted.mean(yrimm_2000plus, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_naturalized_citizen, perwt, na.rm = TRUE),
      mean_female = weighted.mean(female, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      N = n()
    ) %>%
    pivot_longer(cols = -hispanic_migrant_status, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = hispanic_migrant_status, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "60 - 69",
      mean_age_70_79 = "70 - 79",
      mean_age_80_89 = "80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_female = "Female",
      mean_english_speaker = "English Speakers",
      mean_is_citizen = "Citizen",
      mean_age_at_immigration_15 = "Less than 15",
      mean_age_at_immigration_15to49 = "15 - 49",
      mean_age_at_immigration_50plus = "Greater than 50",
      mean_years_in_us = "Years in US",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_yrimm_before1965 = "Before 1965",
      mean_yrimm_1965_1979 = "1965 - 1979",
      mean_yrimm_1980_1999 = "1980 - 1999",
      mean_yrimm_2000plus = "After 2000"
    )) %>% 
    select(-variable)

print(table2_consolidated_migrant)

table2_consolidated <- bind_cols(
  table2_consolidated,
  table2_consolidated_migrant
)

table2_consolidated <- table2_consolidated %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,`foreign-born hispanic`, `foreign-born not hispanic`, `native-born hispanic`, `native-born not hispanic`) %>% 
  rename(
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Demographics = variable,
    Cuba = cuba,
    `Hispanic Immigrant` = `foreign-born hispanic`,
    `Non-Hispanic Immigrant` = `foreign-born not hispanic`,
    `Hispanic Native` = `native-born hispanic`,
    `Non-Hispanic Native` = `native-born not hispanic`,
  ) %>% 
  add_row(Demographics = "Age", .before = 1) %>% 
  add_row(Demographics = "Education Completed", .before = 5) %>% 
  add_row(Demographics = "Age Migrated", .before = 11) %>% 
  add_row(Demographics = "Migration Cohort", .before = 15)

print(table2_consolidated)

table2_consolidated_code <- xtable(table2_consolidated, 
                                   caption = "Sociodemographics of Hispanics in the U.S. by Birth Country (2020 Census)", 
                                   align = "ll|cccccccc")

latex_code <- capture.output(print(table2_consolidated_code, 
                                   type = "latex", 
                                   caption.placement = "top",
                                   size = "\\small",
                                   include.rownames = FALSE))

#to replace align tabular code
tabular_line_index <- grep("\\\\begin\\{tabular\\}", latex_code)
latex_code[tabular_line_index] <- "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|cccccccc}"

# To align rows right
adjustments <- list(
  list(rows = c("60 - 69", "70 - 79", "80 - 89"), width = 1.5),
  list(rows = c("Less than Primary"), width = 3.2),
  list(rows = c("Primary"), width = 1.7),
  list(rows = c("Secondary", "University"), width = 2),
  list(rows = c("Less than 15"), width = 2.4),
  list(rows = c("15 - 49"), width = 1.6),
  list(rows = c("Greater than 50"), width = 2.9),
  list(rows = c("Before 1965"), width = 2.3),
  list(rows = c("1965 - 1979", "1980 - 1999"), width = 2.2),
  list(rows = c("After 2000"), width = 2.1)
)

adjust_latex_rows <- function(latex_code, adjustments) {
  for (adjustment in adjustments) {
    for (row in adjustment$rows) {
      row_index <- grep(paste0("^\\s*", row), latex_code)
      if (length(row_index) > 0) {
        latex_code[row_index] <- gsub(
          "^(\\s*)(.*?)(&.*)",
          sprintf("\\1\\\\multicolumn{1}{>{\\\\raggedleft\\\\arraybackslash}p{%scm}|}{\\\\makebox[%scm][r]{\\2}}\\3",
                  adjustment$width, adjustment$width),
          latex_code[row_index]
        )
      }
    }
  }
  return(latex_code)
}

latex_code <- adjust_latex_rows(latex_code, adjustments)

writeLines(latex_code, "/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/table2_consolidated.tex")

doc <- read_docx()
doc <- doc %>% 
  body_add_par("LaTeX Table Export", style = "heading 1")
doc <- doc %>% 
  body_add_par(paste(latex_code, collapse = "\n"))
print(doc, target = "latex_table_export.docx")
```


table2, both sexes
```{r}
#sample size
create_table_for_sex <- function(sex_value) {
  us_df_2020 %>%
    filter(sex == sex_value) %>%
    filter(bplcountry == "mexico" | 
       bplcountry == "puerto rico" | 
       bplcountry == "dominican republic" |
       bplcountry == "cuba") %>% 
    group_by(bplcountry) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_citizen, perwt, na.rm = TRUE),
      mean_age_at_immigration_15 = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      mean_age_at_immigration_15to49 = weighted.mean(age_at_immigration_15to49, perwt, na.rm = TRUE),
      mean_age_at_immigration_50plus = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE),
      mean_yrimm_before1965 = weighted.mean(yrimm_before1965, perwt, na.rm = TRUE),
      mean_yrimm_1965_1979 = weighted.mean(yrimm_1965to1980, perwt, na.rm = TRUE),
      mean_yrimm_1980_1999 = weighted.mean(yrimm_1980to1999, perwt, na.rm = TRUE),
      mean_yrimm_2000plus = weighted.mean(yrimm_2000plus, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE),
      N = n()
    ) %>%
    pivot_longer(cols = -bplcountry, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = bplcountry, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "60 - 69",
      mean_age_70_79 = "70 - 79",
      mean_age_80_89 = "80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_female = "Female",
      mean_english_speaker = "English Speakers",
      mean_is_citizen = "Citizen",
      mean_age_at_immigration_15 = "Less than 15",
      mean_age_at_immigration_15to49 = "15 - 49",
      mean_age_at_immigration_50plus = "Greater than 50",
      mean_years_in_us = "Years in US",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_yrimm_before1965 = "Before 1965",
      mean_yrimm_1965_1979 = "1965 - 1979",
      mean_yrimm_1980_1999 = "1980 - 1999",
      mean_yrimm_2000plus = "After 2000"
    ))
}

create_table_for_sex_migrants <- function(sex_value) {
  us_df_2020 %>%
    filter(sex == sex_value) %>%
    group_by(hispanic_migrant_status) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_citizen, perwt, na.rm = TRUE),
      mean_age_at_immigration_15 = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      mean_age_at_immigration_15to49 = weighted.mean(age_at_immigration_15to49, perwt, na.rm = TRUE),
      mean_age_at_immigration_50plus = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE),
      mean_yrimm_before1965 = weighted.mean(yrimm_before1965, perwt, na.rm = TRUE),
      mean_yrimm_1965_1979 = weighted.mean(yrimm_1965to1980, perwt, na.rm = TRUE),
      mean_yrimm_1980_1999 = weighted.mean(yrimm_1980to1999, perwt, na.rm = TRUE),
      mean_yrimm_2000plus = weighted.mean(yrimm_2000plus, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE),
      N = n()
    ) %>%
    pivot_longer(cols = -hispanic_migrant_status, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = hispanic_migrant_status, values_from = value) %>%
    mutate(variable = recode(variable,
      mean_age_60_69 = "60 - 69",
      mean_age_70_79 = "70 - 79",
      mean_age_80_89 = "80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_female = "Female",
      mean_english_speaker = "English Speakers",
      mean_is_citizen = "Citizen",
      mean_age_at_immigration_15 = "Less than 15",
      mean_age_at_immigration_15to49 = "15 - 49",
      mean_age_at_immigration_50plus = "Greater than 50",
      mean_years_in_us = "Years in US",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_yrimm_before1965 = "Before 1965",
      mean_yrimm_1965_1979 = "1965 - 1979",
      mean_yrimm_1980_1999 = "1980 - 1999",
      mean_yrimm_2000plus = "After 2000"
    )) %>% 
    select(-variable)
}

table_sex_1 <- create_table_for_sex(1)
table_sex_2 <- create_table_for_sex(2)

table_sex_1_migrant_status <- create_table_for_sex_migrants(1)
table_sex_2_migrant_status <- create_table_for_sex_migrants(2)

combined_table1 <- bind_rows(
  table_sex_2, #females first
  table_sex_1 #males second
)

combined_table2 <- bind_rows(
  table_sex_2_migrant_status, #females first
  table_sex_1_migrant_status #males second
)

combined_table <- bind_cols(
  combined_table1,
  combined_table2
)

combined_table <- combined_table %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  mutate(Gender = ifelse(row_number() == 1, "Women", 
                         ifelse(row_number() == 11, "Men", ""))) %>% 
  select(Gender, variable, `dominican republic`, mexico, `puerto rico`, cuba,`foreign-born hispanic`, `foreign-born not hispanic`, `native-born hispanic`, `native-born not hispanic`) %>% 
  rename(
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Demographics = variable
  ) 

print(combined_table)

table2_code <- xtable(combined_table, caption = "Sociodemographics of Hispanics in the U.S. by Birth Country and Sex (2020 Census)", 
                      align = "ll|l|llllllll")


sink("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/table2.tex")
print(table2_code, type = "latex", 
      caption.placement = "top",
      size = "\\small",
      include.rownames = FALSE)

sink()
```
table 3, consolidated
```{r}
variable_labels <- c(
      mean_age_60_69 = "60 - 69",
      mean_age_70_79 = "70 - 79",
      mean_age_80_89 = "80 - 89",
      mean_married_cohab = "Married/Cohabiting",
      mean_female = "Female",
      mean_english_speaker = "English Speakers",
      mean_is_citizen = "Citizen",
      mean_age_at_immigration_15 = "Less than 15",
      mean_age_at_immigration_15to49 = "15 - 49",
      mean_age_at_immigration_50plus = "Greater than 50",
      mean_years_in_us = "Years in US",
      mean_less_than_primary_completed = "Less than Primary",
      mean_primary_completed = "Primary",
      mean_secondary_completed = "Secondary",
      mean_university_completed = "University",
      mean_yrimm_before1965 = "Before 1965",
      mean_yrimm_1965_1979 = "1965 - 1979",
      mean_yrimm_1980_1999 = "1980 - 1999",
      mean_yrimm_2000plus = "After 2000"
)

table3_consolidated <- us_df_2020 %>%
    filter(!is.na(hispanic_migrant_status_race)) %>% 
    filter(!str_detect(hispanic_migrant_status_race, "not")) %>% 
    group_by(hispanic_migrant_status_race) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_age_at_immigration_15 = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      mean_age_at_immigration_15to49 = weighted.mean(age_at_immigration_15to49, perwt, na.rm = TRUE),
      mean_age_at_immigration_50plus = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE),
      mean_yrimm_before1965 = weighted.mean(yrimm_before1965, perwt, na.rm = TRUE),
      mean_yrimm_1965_1979 = weighted.mean(yrimm_1965to1980, perwt, na.rm = TRUE),
      mean_yrimm_1980_1999 = weighted.mean(yrimm_1980to1999, perwt, na.rm = TRUE),
      mean_yrimm_2000plus = weighted.mean(yrimm_2000plus, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_citizen, perwt, na.rm = TRUE),
      mean_female = weighted.mean(female, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      N = n()
    ) %>%
    pivot_longer(cols = -hispanic_migrant_status_race, names_to = "Demographics", values_to = "value") %>%
    pivot_wider(names_from = hispanic_migrant_status_race, values_from = value) %>%
    mutate(Demographics = Demographics %>% 
             recode(!!!variable_labels))

table3_consolidated <-table3_consolidated %>% 
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  add_row(Demographics = "Age", .before = 1) %>% 
  add_row(Demographics = "Education Completed", .before = 5) %>% 
  add_row(Demographics = "Age Migrated", .before = 11) %>% 
  add_row(Demographics = "Migration Cohort", .before = 15) %>% 
  rename(`Foreign Black Hispanic` = `foreign-born black hispanic`,
         `Foreign White Hispanic` = `foreign-born white hispanic`,
         `Foreign Other Hispanic` = `foreign-born other hispanic`,
         `Native White Hispanic` = `native-born white hispanic`,
         `Native Black Hispanic` = `native-born black hispanic`,
         `Native Other Hispanic` = `native-born other hispanic`) %>% 
  select(Demographics,
         `Foreign Black Hispanic`, `Foreign White Hispanic`, `Foreign Other Hispanic`,
         `Native Black Hispanic`, `Native White Hispanic`, `Native Other Hispanic`)
  
print(table3_consolidated)

colnames(table3_consolidated) <- c("Demographics", 
                                   "Black Hispanic", "White Hispanic", "Other Hispanic",
                                   "Black Hispanic", "White Hispanic", "Other Hispanic")

table3_consolidated_code <- xtable(table3_consolidated, 
                                   caption = "Sociodemographics of Hispanics in the U.S. by Birth Race (2020 Census)", 
                                   align = "ll|cccccc")

# Generate LaTeX code
latex_code <- capture.output(print(table3_consolidated_code, 
                                   type = "latex", 
                                   caption.placement = "top",
                                   size = "\\small",
                                   include.rownames = FALSE))

# Find the position of the header row
header_pos <- which(grepl("Demographics & Black Hispanic", latex_code))

if (length(header_pos) > 0) {
  # Insert the new rows with labels
  new_rows <- c(
    "  & \\multicolumn{3}{c|}{Foreign Born} & \\multicolumn{3}{c}{Native Born} \\\\",
    "\\cline{2-7}"
  )
  latex_code <- c(latex_code[1:(header_pos-1)], 
                  new_rows,
                  latex_code[header_pos:length(latex_code)])
} else {
  warning("Could not find the header row in the LaTeX code.")
}

#to replace align tabular code
tabular_line_index <- grep("\\\\begin\\{tabular\\}", latex_code)
latex_code[tabular_line_index] <- "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|cccccc}"

# To align rows right
# Define adjustments
adjustments <- list(
  list(rows = c("60 - 69", "70 - 79", "80 - 89"), width = 1.5),
  list(rows = c("Less than Primary"), width = 3.2),
  list(rows = c("Primary"), width = 1.7),
  list(rows = c("Secondary", "University"), width = 2),
  list(rows = c("Less than 15"), width = 2.4),
  list(rows = c("15 - 49"), width = 1.6),
  list(rows = c("Greater than 50"), width = 2.9),
  list(rows = c("Before 1965"), width = 2.3),
  list(rows = c("1965 - 1979", "1980 - 1999"), width = 2.2),
  list(rows = c("After 2000"), width = 2.1)
)

adjust_latex_rows <- function(latex_code, adjustments) {
  for (adjustment in adjustments) {
    for (row in adjustment$rows) {
      row_index <- grep(paste0("^\\s*", row), latex_code)
      if (length(row_index) > 0) {
        latex_code[row_index] <- gsub(
          "^(\\s*)(.*?)(&.*)",
          sprintf("\\1\\\\multicolumn{1}{>{\\\\raggedleft\\\\arraybackslash}p{%scm}|}{\\\\makebox[%scm][r]{\\2}}\\3",
                  adjustment$width, adjustment$width),
          latex_code[row_index]
        )
      }
    }
  }
  return(latex_code)
}

latex_code <- adjust_latex_rows(latex_code, adjustments)

writeLines(latex_code, "/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/table3_consolidated.tex")
```

table 3
```{r}
variable_labels <- c(
  mean_age = "Age",
  mean_married_cohab = "Married/Cohabiting",
  mean_english_speaker = "English Speakers",
  mean_is_citizen = "Citizen",
  mean_age_at_immigration = "Age at Immigration",
  mean_years_in_us = "Years in US",
  mean_less_than_primary_completed = "Less than Primary Completed",
  mean_primary_completed = "Primary Completed",
  mean_secondary_completed = "Secondary Completed",
  mean_university_completed = "University Completed"
)

create_table_for_race <- function(sex_value) {
  us_df_2020 %>%
    filter(sex == sex_value) %>%
    filter(!is.na(hispanic_migrant_status_race)) %>% 
    group_by(hispanic_migrant_status_race) %>%
    summarise(
      mean_age = weighted.mean(age, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_english_speaker = weighted.mean(english_speaker, perwt, na.rm = TRUE),
      mean_is_citizen = weighted.mean(is_citizen, perwt, na.rm = TRUE),
      mean_age_at_immigration = weighted.mean(age_at_immigration, perwt, na.rm = TRUE),
      mean_years_in_us = weighted.mean(years_in_us, perwt, na.rm = TRUE),
      mean_less_than_primary_completed = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary_completed = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary_completed = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university_completed = weighted.mean(university_completed, perwt, na.rm = TRUE)
    ) %>%
    pivot_longer(cols = -hispanic_migrant_status_race, names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = hispanic_migrant_status_race, values_from = value) %>%
    mutate(variable = variable %>% 
             recode(!!!variable_labels))
}

table_sex_1 <- create_table_for_race(1)
table_sex_2 <- create_table_for_race(2)

combined_table <- bind_rows(
  table_sex_2, #females first
  table_sex_1 #males second
)

combined_table <- combined_table %>%
  mutate(across(where(is.numeric), round, digits = 2)) %>% 
  mutate(across(everything(), ~ as.character(.))) %>%    
  mutate(across(everything(), ~ ifelse(. == "NaN", "-", .))) %>%   
  mutate(across(everything(), ~ ifelse(. == "0", "-", .))) %>% 
  mutate(across(everything(), ~ ifelse(. == "1", "-", .))) %>% 
  mutate(Gender = ifelse(row_number() == 1, "Women", 
                         ifelse(row_number() == 11, "Men", ""))) %>% 
  select(Gender, everything()) %>% 
  rename(Demographics = variable) 

print(combined_table)

table3_code <- xtable(combined_table, caption = "Summary Statistics by Country and Sex", 
                      align = "ll|l|p{1.5cm}p{1.5cm}p{1.5cm}p{1.5cm}p{1.5cm}p{1.5cm}p{1.5cm}")


sink("/Users/chrissoria/Documents/Research/us_international_ses/tables/r_tables/table3.tex")
print(table3_code, type = "latex", 
      caption.placement = "top",
      size = "\\small",
      include.rownames = FALSE)

sink()
```

