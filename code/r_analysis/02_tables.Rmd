---
title: "tables"
author: "Chris Soria"
date: "2024-09-28"
output: html_document
---

# Libraries
```{r}
library(haven)
library(tidyverse)
library(rlang)
library(xtable)
library(kableExtra)
library(readxl)
library(officer)
library(broom)
library(writexl)
library(scales)
library(readr)
```

# Setup
```{r}
target_dir <- normalizePath("/Users/chrissoria/Documents/Research/us_international_ses/code")
current_dir <- normalizePath(getwd())

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/code/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots/")
  table_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/tables/")
} else {
  out_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/code")
  data_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/data")
  plot_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/plots")
  table_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/tables")
}

census_2010 <- "US_2010_v100_census.dta"
acs_2010 <- "US_2010_v100.dta"

# Source helper functions
if (current_dir == target_dir) {
  source("/Users/chrissoria/Documents/Research/us_international_ses/code/helpers/table_functions.R")
} else {
  source("C:/Users/Ty/Documents/GitHub/international_migration_ses/code/helpers/table_functions.R")
}
```

# Reading in Data
```{r}
# Load US data
us_df_2010 <- read_dta(paste0(data_dir, acs_2010)) %>% add_us_derived_vars()
us_df_2020 <- read_dta(paste0(data_dir, "US_2020_v100.dta")) %>%
  add_us_derived_vars() %>%
  mutate(
    age_at_immig_groups_string = case_when(
      age_at_immigration_groups == 1 ~ "Under 15",
      age_at_immigration_groups == 2 ~ "15-24",
      age_at_immigration_groups == 3 ~ "25-49",
      age_at_immigration_groups == 4 ~ "50 and above"
    ),
    age_at_immig_groups_string = factor(age_at_immig_groups_string,
                                        levels = c("Under 15", "15-24", "25-49", "50 and above"))
  )

# Load international data
# Use perwt_age_standardized for age-adjusted comparisons with US populations
in_df <- read_dta(paste0(data_dir, "CuDrMePrUs_10_12.dta")) %>%
  mutate(
    country_year = as_factor(country_year),
    secondary_or_above = secondary_completed + university_completed,
    perwt = perwt_age_standardized  # Use age-standardized weights for all international comparisons
  )
```

# Table 2: US Hispanics by Birth Country (2020)
```{r}
# Main countries
table2_main <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  create_summary_table("country_string", include_cognitive = TRUE)

# Other migrants by hispanic category
table2_migrant <- us_df_2020 %>%
  filter(!country_string %in% main_countries) %>%
  filter(!hispanic_category_migrant_status %in% c("native-born Not Latino")) %>%
  create_summary_table("hispanic_category_migrant_status", include_cognitive = TRUE) %>%
  select(-variable)

# Native-born by race
table2_native <- us_df_2020 %>%
  filter(race_native_category %in% c(10, 11, 12)) %>%
  create_summary_table("race_native_category", include_cognitive = TRUE) %>%
  select(-variable) %>%
  rename(Black = `10`, White = `11`, Other = `12`)

# Combine
table2 <- bind_cols(table2_main, table2_migrant, table2_native) %>%
  format_table() %>%
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,
         `foreign-born Central-American Latino`, `foreign-born Other Latino`,
         `foreign-born Not Latino`, `native-born Other Latino`, Black, White, Other) %>%
  rename(
    Demographics = variable,
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Cuba = cuba,
    `Central America` = `foreign-born Central-American Latino`,
    `Latin America` = `foreign-born Other Latino`,
    `Other Countries` = `foreign-born Not Latino`,
    Hispanic = `native-born Other Latino`
  )

# Add category headers
for (i in seq_along(us_table_headers)) {
  table2 <- table2 %>% add_row(Demographics = names(us_table_headers)[i],
                                .before = us_table_headers[[i]] + (i - 1))
}

export_table(
  table2,
  excel_path = paste0(table_dir, "table2.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table1.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2016-20 ACS)",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)

# Table 11: Same as Table 2 but WITHOUT cognitive/independence difficulty variables
table11_main <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  create_summary_table("country_string", include_cognitive = FALSE)

table11_migrant <- us_df_2020 %>%
  filter(!country_string %in% main_countries) %>%
  filter(!hispanic_category_migrant_status %in% c("native-born Not Latino")) %>%
  create_summary_table("hispanic_category_migrant_status", include_cognitive = FALSE) %>%
  select(-variable)

table11_native <- us_df_2020 %>%
  filter(race_native_category %in% c(10, 11, 12)) %>%
  create_summary_table("race_native_category", include_cognitive = FALSE) %>%
  select(-variable) %>%
  rename(Black = `10`, White = `11`, Other = `12`)

table11 <- bind_cols(table11_main, table11_migrant, table11_native) %>%
  format_table() %>%
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,
         `foreign-born Central-American Latino`, `foreign-born Other Latino`,
         `foreign-born Not Latino`, `native-born Other Latino`, Black, White, Other) %>%
  rename(
    Demographics = variable,
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Cuba = cuba,
    `Central America` = `foreign-born Central-American Latino`,
    `Latin America` = `foreign-born Other Latino`,
    `Other Countries` = `foreign-born Not Latino`,
    Hispanic = `native-born Other Latino`
  )

for (i in seq_along(us_table_headers)) {
  table11 <- table11 %>% add_row(Demographics = names(us_table_headers)[i],
                                .before = us_table_headers[[i]] + (i - 1))
}

export_table(
  table11,
  excel_path = paste0(table_dir, "table11.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table11.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2016-20 ACS)",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)
```

# Table 3: International Comparison by Sex
```{r}
table3 <- create_intl_comparison_table(in_df, us_df_2010)

# Add headers for female and male sections
table3 <- table3 %>%
  add_row(Demographics = "Age", .before = 1) %>%
  add_row(Demographics = "Education Completed", .before = 6) %>%
  add_row(Demographics = "Household", .before = 11) %>%
  add_row(Demographics = "Age", .before = 17) %>%
  add_row(Demographics = "Education Completed", .before = 22) %>%
  add_row(Demographics = "Household", .before = 27) %>%
  mutate(Gender = ifelse(row_number() == 1, "Female",
                         ifelse(row_number() == 17, "Male", ""))) %>%
  select(Gender, everything())

export_table(
  table3,
  excel_path = paste0(table_dir, "table3.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table3.tex"),
  caption = "Summary Statistics by Country and Sex For Hispanics in Their Native Countries",
  align = "lll|cccccccc",
  tabular_override = "\\begin{tabular}{l>{\\raggedright\\arraybackslash}p{3.2cm}|ccccccccc}"
)
```

# Supplemental Tables: English Proficiency by Group
```{r}
# Proportion of age groups that speak English
prop_english_by_age <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  group_by(country_string, age_groups) %>%
  summarise(mean_english = weighted.mean(english_speaker, perwt, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = country_string, values_from = mean_english) %>%
  mutate(age_groups = recode(as.character(age_groups),
                             "1" = "60 - 69", "2" = "70 - 79", "3" = "80 - 89"))

# Proportion of migration cohorts that speak English
prop_english_by_cohort <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  group_by(country_string, year_of_immigration_groups) %>%
  summarise(mean_english = weighted.mean(english_speaker, perwt, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = country_string, values_from = mean_english) %>%
  mutate(year_of_immigration_groups = recode(as.character(year_of_immigration_groups),
                                              "1" = "Before 1965", "2" = "1965 - 1979",
                                              "3" = "1980 - 1999", "4" = "After 1999")) %>%
  mutate(year_of_immigration_groups = factor(year_of_immigration_groups,
                                              levels = c("Before 1965", "1965 - 1979",
                                                        "1980 - 1999", "After 1999")))

print(prop_english_by_age)
print(prop_english_by_cohort)
```

# Supplemental Table: 2010 ACS Comparison
```{r}
# Same structure as Table 2 but for 2010 data
table_2010_main <- us_df_2010 %>%
  filter(country_string %in% main_countries) %>%
  create_summary_table("country_string", include_cognitive = TRUE)

table_2010_migrant <- us_df_2010 %>%
  filter(!country_string %in% main_countries) %>%
  filter(!hispanic_category_migrant_status %in% c("native-born Not Latino")) %>%
  create_summary_table("hispanic_category_migrant_status", include_cognitive = TRUE) %>%
  select(-variable)

table_2010_native <- us_df_2010 %>%
  filter(race_native_category %in% c(10, 11, 12)) %>%
  create_summary_table("race_native_category", include_cognitive = TRUE) %>%
  select(-variable) %>%
  rename(Black = `10`, White = `11`, Other = `12`)

table_2010 <- bind_cols(table_2010_main, table_2010_migrant, table_2010_native) %>%
  format_table() %>%
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,
         `foreign-born Central-American Latino`, `foreign-born Other Latino`,
         `foreign-born Not Latino`, `native-born Other Latino`, Black, White, Other) %>%
  rename(
    Demographics = variable,
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Cuba = cuba,
    `Central America` = `foreign-born Central-American Latino`,
    `Latin America` = `foreign-born Other Latino`,
    `Other Countries` = `foreign-born Not Latino`,
    Hispanic = `native-born Other Latino`
  )

for (i in seq_along(us_table_headers)) {
  table_2010 <- table_2010 %>% add_row(Demographics = names(us_table_headers)[i],
                                        .before = us_table_headers[[i]] + (i - 1))
}

export_table(
  table_2010,
  excel_path = paste0(table_dir, "table6.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table1_2010.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2006-10 ACS)",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)

# Table 12: Same as 2010 table but WITHOUT cognitive/independence difficulty variables
table12_main <- us_df_2010 %>%
  filter(country_string %in% main_countries) %>%
  create_summary_table("country_string", include_cognitive = FALSE)

table12_migrant <- us_df_2010 %>%
  filter(!country_string %in% main_countries) %>%
  filter(!hispanic_category_migrant_status %in% c("native-born Not Latino")) %>%
  create_summary_table("hispanic_category_migrant_status", include_cognitive = FALSE) %>%
  select(-variable)

table12_native <- us_df_2010 %>%
  filter(race_native_category %in% c(10, 11, 12)) %>%
  create_summary_table("race_native_category", include_cognitive = FALSE) %>%
  select(-variable) %>%
  rename(Black = `10`, White = `11`, Other = `12`)

table12 <- bind_cols(table12_main, table12_migrant, table12_native) %>%
  format_table() %>%
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,
         `foreign-born Central-American Latino`, `foreign-born Other Latino`,
         `foreign-born Not Latino`, `native-born Other Latino`, Black, White, Other) %>%
  rename(
    Demographics = variable,
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Cuba = cuba,
    `Central America` = `foreign-born Central-American Latino`,
    `Latin America` = `foreign-born Other Latino`,
    `Other Countries` = `foreign-born Not Latino`,
    Hispanic = `native-born Other Latino`
  )

for (i in seq_along(us_table_headers)) {
  table12 <- table12 %>% add_row(Demographics = names(us_table_headers)[i],
                                .before = us_table_headers[[i]] + (i - 1))
}

export_table(
  table12,
  excel_path = paste0(table_dir, "table12.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table12.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2006-10 ACS)",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)
```

# Supplemental Tables: By Sex (2020)
```{r}
# Female table
table_female <- create_sex_specific_table(us_df_2020, 2, "2020")
export_table(
  table_female,
  excel_path = paste0(table_dir, "table4.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table1_female.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2016-20 ACS): Females",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)

# Male table
table_male <- create_sex_specific_table(us_df_2020, 1, "2020")
export_table(
  table_male,
  excel_path = paste0(table_dir, "table5.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table1_male.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2016-20 ACS): Males",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)
```

# Supplemental Table 5: Age-Standardized International Comparison (2010)
```{r}
table_standardized <- create_intl_comparison_table(in_df, us_df_2010)

table_standardized <- table_standardized %>%
  add_row(Demographics = "Age", .before = 1) %>%
  add_row(Demographics = "Education Completed", .before = 6) %>%
  add_row(Demographics = "Household", .before = 11) %>%
  add_row(Demographics = "Age", .before = 17) %>%
  add_row(Demographics = "Education Completed", .before = 22) %>%
  add_row(Demographics = "Household", .before = 27) %>%
  mutate(Gender = ifelse(row_number() == 1, "Female",
                         ifelse(row_number() == 17, "Male", ""))) %>%
  select(Gender, everything())

export_table(
  table_standardized,
  excel_path = paste0(table_dir, "table8.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table2_standardized.tex"),
  caption = "Summary Statistics by Country and Sex For Hispanics in Their Native Countries (Age-Standardized)",
  align = "lll|cccccccc",
  tabular_override = "\\begin{tabular}{l>{\\raggedright\\arraybackslash}p{3.2cm}|ccccccccc}"
)
```

# Supplemental Table: 2010 vs 2020 Comparison
```{r}
table_2010_2020 <- create_year_comparison_table(in_df, us_df_2010, us_df_2020)

export_table(
  table_2010_2020,
  excel_path = paste0(table_dir, "table9.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table2_2010_2020.tex"),
  caption = "Summary Statistics by Country and Sex For Hispanics in Their Native Countries (2010 and 2020)",
  align = "lll|cccccc",
  tabular_override = "\\begin{tabular}{l>{\\raggedright\\arraybackslash}p{3.2cm}|cccccc}"
)
```

# Supplemental Table: Education by Birth Cohort
```{r}
# Add birth year and country_year to US data
in_df <- in_df %>% mutate(birth_year = year - age)
us_df_2010 <- us_df_2010 %>%
  mutate(birth_year = year - age,
         country_year = paste0(country_string, "_", year))
us_df_2020_filtered <- us_df_2020 %>%
  mutate(birth_year = year - age,
         country_year = paste0(country_string, "_", year)) %>%
  filter(yrimmig < 2011)

# Mexico education comparison
edu_mexico_intl <- bind_rows(
  create_education_cohort_table(in_df, 2, "country_year") %>% select(variable, Mexico_2010, Mexico_2020),
  create_education_cohort_table(in_df, 1, "country_year") %>% select(variable, Mexico_2010, Mexico_2020)
)

edu_mexico_us_2010 <- bind_rows(
  create_education_cohort_table(us_df_2010, 2, "country_year") %>% select(mexico_2010),
  create_education_cohort_table(us_df_2010, 1, "country_year") %>% select(mexico_2010)
)

edu_mexico_us_2020 <- bind_rows(
  create_education_cohort_table(us_df_2020_filtered, 2, "country_year") %>% select(mexico_2020),
  create_education_cohort_table(us_df_2020_filtered, 1, "country_year") %>% select(mexico_2020)
)

table_edu_mexico <- bind_cols(edu_mexico_intl, edu_mexico_us_2010, edu_mexico_us_2020) %>%
  format_table() %>%
  rename(
    Demographics = variable,
    `Mexico (Home) 2010` = Mexico_2010,
    `Mexico (Home) 2020` = Mexico_2020,
    `US Mexican-born 2010` = mexico_2010,
    `US Mexican-born 2020` = mexico_2020
  )

export_table(
  table_edu_mexico,
  excel_path = paste0(table_dir, "table10.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table_prop_education_mexico_code.tex"),
  caption = "Education Levels for 1930-1950 Birth Cohort: Mexico",
  align = "ll|cccc"
)
```

# Table 7: Migrants Who Arrived After Age 24
```{r}
# Filter for migrants who arrived after age 24
us_25plus <- us_df_2020 %>%
  filter(age_at_immigration_under15 == 0, age_at_immigration_15to24 == 0)

# Main countries
table7_main <- us_25plus %>%
  filter(country_string %in% main_countries) %>%
  calculate_summary_25plus("country_string")

# Other migrants
table7_migrant <- us_25plus %>%
  filter(!country_string %in% main_countries) %>%
  filter(!hispanic_category_migrant_status %in% c("native-born Not Latino")) %>%
  calculate_summary_25plus("hispanic_category_migrant_status") %>%
  select(-variable)

# Native-born by race
table7_native <- us_25plus %>%
  filter(race_native_category %in% c(10, 11, 12)) %>%
  calculate_summary_25plus("race_native_category") %>%
  select(-variable) %>%
  rename(Black = `10`, White = `11`, Other = `12`)

# Combine
table7 <- bind_cols(table7_main, table7_migrant, table7_native) %>%
  format_table() %>%
  select(variable, mexico, `puerto rico`, `dominican republic`, cuba,
         `foreign-born Central-American Latino`, `foreign-born Other Latino`,
         `foreign-born Not Latino`, `native-born Other Latino`, Black, White, Other) %>%
  rename(
    Demographics = variable,
    `Dominican Republic` = `dominican republic`,
    Mexico = mexico,
    `Puerto Rico` = `puerto rico`,
    Cuba = cuba,
    `Central America` = `foreign-born Central-American Latino`,
    `Latin America` = `foreign-born Other Latino`,
    `Other Countries` = `foreign-born Not Latino`,
    Hispanic = `native-born Other Latino`
  )

# Add category headers (different positions for 25+ table)
table7_headers <- list(
  "Age" = 1,
  "Education Completed" = 6,
  "Household" = 11,
  "Age Migrated" = 16,
  "Migration Cohort" = 19,
  "Acculturation" = 24
)

for (i in seq_along(table7_headers)) {
  table7 <- table7 %>% add_row(Demographics = names(table7_headers)[i],
                                .before = table7_headers[[i]] + (i - 1))
}

export_table(
  table7,
  excel_path = paste0(table_dir, "table7.xlsx"),
  latex_path = paste0(table_dir, "r_tables/table1_25_plus.tex"),
  caption = "Sociodemographic Comparison of Hispanics in the U.S. by Birth Country (2016-20 ACS): Migrated After Age 24",
  align = "ll|ccccccccccc",
  tabular_override = "\\begin{tabular}{>{\\raggedright\\arraybackslash}p{3.2cm}|lcccccc|cccc}"
)
```

# Alternative Education Tables (using alt education variables)
```{r}
alt_edu_2010 <- create_alt_education_table(us_df_2010)
alt_edu_2020 <- create_alt_education_table(us_df_2020)

alt_edu_tables <- bind_rows(alt_edu_2010, alt_edu_2020) %>%
  add_row(Demographics = "2010", .before = 1) %>%
  add_row(Demographics = "2020", .before = 7)

write_xlsx(alt_edu_tables, paste0(table_dir, "alt_education_table.xlsx"))
```
