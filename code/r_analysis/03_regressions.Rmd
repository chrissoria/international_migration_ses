---
title: "Regressions"
author: "Chris Soria"
date: "2025-01-08"
output: html_document
---

# Packages
```{r}
library(tidyverse)
library(broom)
library(cowplot)
library(writexl)
library(scales)
library(haven)
library(emmeans)
```

# Setup
```{r setup}
target_dir <- normalizePath("/Users/chrissoria/Documents/Research/us_international_ses/code")
current_dir <- normalizePath(getwd())

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/code/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots/")
  reg_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/regressions/")
} else {
  out_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/code/")
  data_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/data/")
  plot_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/plots/")
  reg_dir <- file.path("C:/Users/Ty/Documents/GitHub/international_migration_ses/regressions/")
}

print(getwd())
```

# Constants and Labels
```{r}
# Standard dependent variables
dvs_standard <- c("married_cohab", "lives_alone", "english_speaker", "secondary_or_above",
                  "is_naturalized_citizen", "less_than_primary_completed")

# Control variables for multivariate models
ivs_controls <- c("age_at_immigration_15to24", "age_at_immigration_25to49",
                  "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980",
                  "yrimm_1980to1999", "female", "age_70to79", "age_80to89", "age_90plus")

# Countries of interest
main_countries <- c("mexico", "puerto rico", "dominican republic", "cuba")
countries_no_pr <- c("mexico", "dominican republic", "cuba")  # For citizenship models

# Term labels for output tables
term_labels <- c(
  country_stringcuba = "Cuba",
  `country_stringdominican republic` = "Dominican Republic",
  country_stringdominican.republic = "Dominican Republic",
  country_stringpuerto.rico = "Puerto Rico",
  `country_stringpuerto rico` = "Puerto Rico",
  age_at_immigration_15to24 = "Immigrated Age 15-24",
  age_at_immigration_25to49 = "Immigrated Age 25-49",
  age_at_immigration_50plus = "Immigrated Age 50+",
  yrimm_before1965 = "Immigrated Before 1965",
  yrimm_1965to1980 = "Immigrated 1965-1980",
  yrimm_1980to1999 = "Immigrated 1980-1999",
  female = "Female",
  age_70to79 = "Age 70-79",
  age_80to89 = "Age 80-89",
  age_90plus = "Age 90+"
)

term_labels_interaction <- c(
  cuba = "Cuba",
  `dominican republic` = "Dominican Republic",
  `puerto rico` = "Puerto Rico",
  mexico = "Mexico"
)

# Color palette for plots
country_colors <- c(
  "mexico" = "#E69F00",
  "puerto rico" = "#56B4E9",
  "dominican republic" = "#009E73",
  "cuba" = "#CC79A7"
)
```

# Core Functions
```{r}
# Filter and prepare data for regression
prepare_regression_data <- function(data, dv, sex_filter = NULL) {
  # Determine countries based on DV

current_countries <- if (dv == "is_naturalized_citizen") countries_no_pr else main_countries

  data_filtered <- data %>%
    filter(country_string %in% current_countries) %>%
    mutate(country_string = fct_relevel(country_string, "mexico"))

  # Apply sex filter if specified
  if (!is.null(sex_filter)) {
    data_filtered <- data_filtered %>% filter(sex == sex_filter)
  }

  data_filtered
}

# Run regression models for all DVs
run_regression_models <- function(data, ivs, sex_filter = NULL, print_summaries = TRUE) {

  sex_label <- if (is.null(sex_filter)) "all" else if (sex_filter == 1) "male" else "female"
  results_list <- list()

  for (dv in dvs_standard) {
    data_filtered <- prepare_regression_data(data, dv, sex_filter)

    # Remove secondary_or_above from IVs for less_than_primary model
    current_ivs <- if (dv == "less_than_primary_completed") {
      ivs[!ivs %in% "secondary_or_above"]
    } else {
      ivs
    }

    formula <- as.formula(paste(dv, "~", paste(current_ivs, collapse = " + ")))
    model <- lm(formula, data = data_filtered, weights = perwt)
    results_list[[dv]] <- model
  }

  # Print summaries if requested
  if (print_summaries) {
    summaries <- map(results_list, summary)
    for (dv in names(summaries)) {
      cat("\n\n", "Summary for", dv, "(", sex_label, "):\n")
      print(summaries[[dv]])
    }
  }

  results_list
}

# Create unadjusted (country-only) models
create_unadjusted_models <- function(data, sex_filter = NULL) {
  run_regression_models(data, ivs = "country_string", sex_filter = sex_filter)
}

# Create adjusted (multivariate) models
create_adjusted_models <- function(data, sex_filter = NULL) {
  run_regression_models(data, ivs = c("country_string", ivs_controls), sex_filter = sex_filter)
}

# Create interaction models (country * year)
create_interaction_models <- function(data, include_controls = FALSE, sex_filter = NULL) {

  if (include_controls) {
    ivs <- c("country_string*year", ivs_controls)
  } else {
    ivs <- "country_string*year"
  }

  results_list <- run_regression_models(data, ivs = ivs, sex_filter = sex_filter)

  # Extract interaction coefficients
  country_coefs <- map_dfr(names(results_list), function(dv) {
    tidy(results_list[[dv]]) %>%
      filter(str_detect(term, "year2020")) %>%
      mutate(outcome = dv,
             term = str_remove(term, "country_string"),
             term = str_remove(term, ":year2020"))
  }) %>%
    pivot_wider(names_from = outcome, values_from = c(estimate, std.error, statistic, p.value)) %>%
    arrange(match(term, c("cuba", "dominican republic", "mexico", "puerto rico")))

  list(models = results_list, coefs = country_coefs)
}

# Format coefficient with significance stars
format_coef <- function(estimate, std_error, p_value) {
  stars <- case_when(
    p_value < 0.01 ~ "***",
    p_value < 0.05 ~ "**",
    p_value < 0.10 ~ "*",
    TRUE ~ ""
  )
  paste0(round(estimate, 3), stars, "\n(", round(std_error, 3), ")")
}

# Generate Excel output for regression results
export_regression_table <- function(results_unadj, results_adj,
                                    results_female_unadj, results_female_adj,
                                    results_male_unadj, results_male_adj,
                                    dv, output_path, term_labels_map = term_labels,
                                    filter_terms = NULL) {

  models <- list(
    "Unadjusted" = results_unadj[[dv]],
    "Adjusted" = results_adj[[dv]],
    "Unadjusted (Females Only)" = results_female_unadj[[dv]],
    "Adjusted (Females Only)" = results_female_adj[[dv]],
    "Unadjusted (Males Only)" = results_male_unadj[[dv]],
    "Adjusted (Males Only)" = results_male_adj[[dv]]
  )

  combined <- map2_dfr(models, names(models), function(model, model_name) {
    tidy(model) %>% mutate(model = model_name)
  })

  # Apply term filter if specified (for interaction models)
  if (!is.null(filter_terms)) {
    combined <- combined %>% filter(str_detect(term, filter_terms))
  }

  combined <- combined %>%
    mutate(
      term = if (!is.null(filter_terms)) {
        str_remove(term, "country_string") %>% str_remove(":year2020")
      } else {
        term
      },
      term = term_labels_map[make.names(term)],
      coef_se = format_coef(estimate, std.error, p.value)
    ) %>%
    select(term, model, coef_se) %>%
    filter(!is.na(term)) %>%
    pivot_wider(names_from = model, values_from = coef_se)

  # Add N and R-squared rows
  model_stats <- tibble(
    model = names(models),
    n = map_int(models, nobs),
    r2 = map_dbl(models, ~glance(.x)$r.squared)
  )

  n_row <- model_stats %>%
    mutate(stat = as.character(n)) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "N", .before = 1)

  r2_row <- model_stats %>%
    mutate(stat = as.character(round(r2, 3))) %>%
    select(model, stat) %>%
    pivot_wider(names_from = model, values_from = stat) %>%
    mutate(term = "R-squared", .before = 1)

  combined <- bind_rows(combined, n_row, r2_row)

  write_xlsx(combined, path = output_path)
  invisible(combined)
}

# Run education/citizenship model for emmeans analysis
run_outcome_model <- function(data, dv, country,
                              include_citizen = TRUE, include_english = TRUE) {

  base_formula <- paste(dv, "~ age + as.factor(female) + race_string + married_cohab + year_of_immig_groups_string + age_at_immig_groups_string")

  if (include_citizen) {
    base_formula <- paste(base_formula, "+ as.factor(is_naturalized_citizen)")
  }
  if (include_english) {
    base_formula <- paste(base_formula, "+ as.factor(english_speaker)")
  }

  data %>%
    filter(country_string == country) %>%
    glm(as.formula(base_formula),
        data = .,
        family = binomial(),
        weights = perwt)
}

# Get emmeans summary with standard reference values
get_emmeans_summary <- function(model,
                                specs = "age_at_immig_groups_string",
                                age = 65,
                                female = 1,
                                race_string = "white hispanic",
                                year_of_immig_groups_string = "1980 - 1999",
                                english_speaker = NULL,
                                is_naturalized_citizen = NULL) {

  at_list <- list(age = age, female = female, race_string = race_string,
                  year_of_immig_groups_string = year_of_immig_groups_string)

  if (!is.null(english_speaker)) at_list$english_speaker <- english_speaker
  if (!is.null(is_naturalized_citizen)) at_list$is_naturalized_citizen <- is_naturalized_citizen

  emm <- emmeans(model, specs = specs, at = at_list, type = "response")
  transform(summary(emm))
}

# NOTE: Emmeans plotting functions (create_emmeans_plot, create_emmeans_line_plot)
# have been moved to 06_regression_plots.Rmd

# Process interaction coefficients
process_interaction_coefs <- function(coefs, prefix = "mean_") {
  coefs %>%
    mutate(
      term = case_when(
        term == "year2020" ~ "mexico",
        TRUE ~ term
      )
    ) %>%
    mutate(
      across(
        starts_with("estimate_"),
        ~ if_else(term == "mexico", .x, .x + .x[term == "mexico"]),
        .names = paste0(prefix, "{.col}")
      )
    )
}
```

# Load Data
```{r}
us_df_2010 <- read_dta(paste0(data_dir, "US_2010_v100.dta"))
us_df_2020 <- read_dta(paste0(data_dir, "US_2020_v100.dta"))

# Prepare filtered datasets
vars_to_select <- c("married_cohab", "age_at_immigration_15to24", "age_at_immigration_25to49",
                    "age_at_immigration_50plus", "yrimm_before1965", "yrimm_1965to1980",
                    "yrimm_1980to1999", "female", "country_string", "lives_alone",
                    "english_speaker", "secondary_or_above", "age_70to79", "age_80to89",
                    "age_90plus", "perwt", "year", "is_naturalized_citizen",
                    "less_than_primary_completed", "sex")

us_df_2010_filtered <- us_df_2010 %>%
  filter(country_string %in% main_countries) %>%
  mutate(country_string = fct_relevel(country_string, "mexico"),
         year = haven::as_factor(year)) %>%
  select(all_of(vars_to_select))

us_df_2020_filtered <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  mutate(country_string = fct_relevel(country_string, "mexico"),
         year = haven::as_factor(year)) %>%
  select(all_of(vars_to_select))

us_df_all <- bind_rows(us_df_2010_filtered, us_df_2020_filtered)
```

# Regressions

## Unadjusted Models (No Controls)
```{r}
# 2020 models
results_all_2020 <- create_unadjusted_models(us_df_2020)
results_male_2020 <- create_unadjusted_models(us_df_2020, sex_filter = 1)
results_female_2020 <- create_unadjusted_models(us_df_2020, sex_filter = 2)

# 2010 models
results_all_2010 <- create_unadjusted_models(us_df_2010)
results_male_2010 <- create_unadjusted_models(us_df_2010, sex_filter = 1)
results_female_2010 <- create_unadjusted_models(us_df_2010, sex_filter = 2)
```

## Adjusted Models (Full Multivariate)
```{r}
# 2020 models
country_coefs_2020 <- create_adjusted_models(us_df_2020)
male_country_coefs_2020 <- create_adjusted_models(us_df_2020, sex_filter = 1)
female_country_coefs_2020 <- create_adjusted_models(us_df_2020, sex_filter = 2)

# 2010 models
country_coefs_2010 <- create_adjusted_models(us_df_2010)
male_country_coefs_2010 <- create_adjusted_models(us_df_2010, sex_filter = 1)
female_country_coefs_2010 <- create_adjusted_models(us_df_2010, sex_filter = 2)
```

## Table Output
```{r}
# Export 2020 tables
for (dv in dvs_standard) {
  export_regression_table(
    results_all_2020, country_coefs_2020,
    results_female_2020, female_country_coefs_2020,
    results_male_2020, male_country_coefs_2020,
    dv = dv,
    output_path = paste0(reg_dir, dv, "_models_2020.xlsx")
  )
}

# Export 2010 tables
for (dv in dvs_standard) {
  export_regression_table(
    results_all_2010, country_coefs_2010,
    results_female_2010, female_country_coefs_2010,
    results_male_2010, male_country_coefs_2010,
    dv = dv,
    output_path = paste0(reg_dir, dv, "_models_2010.xlsx")
  )
}
```

# Year of Migration Interaction Models

## Univariate Interaction
```{r}
# Create interaction models without controls
interaction_unadj <- create_interaction_models(us_df_all, include_controls = FALSE)
interaction_unadj_male <- create_interaction_models(us_df_all, include_controls = FALSE, sex_filter = 1)
interaction_unadj_female <- create_interaction_models(us_df_all, include_controls = FALSE, sex_filter = 2)

# Process coefficients
country_coefs_interaction_no_cont <- process_interaction_coefs(interaction_unadj$coefs)
male_country_coefs_interaction_no_cont <- process_interaction_coefs(interaction_unadj_male$coefs)
female_country_coefs_interaction_no_cont <- process_interaction_coefs(interaction_unadj_female$coefs)
```

## Multivariate Interaction
```{r}
# Create interaction models with controls
interaction_adj <- create_interaction_models(us_df_all, include_controls = TRUE)
interaction_adj_male <- create_interaction_models(us_df_all, include_controls = TRUE, sex_filter = 1)
interaction_adj_female <- create_interaction_models(us_df_all, include_controls = TRUE, sex_filter = 2)

# Process coefficients
country_coefs_interaction <- process_interaction_coefs(interaction_adj$coefs, prefix = "adjusted_mean_")
male_country_coefs_interaction <- process_interaction_coefs(interaction_adj_male$coefs, prefix = "adjusted_mean_")
female_country_coefs_interaction <- process_interaction_coefs(interaction_adj_female$coefs, prefix = "adjusted_mean_")
```

## Interaction Table Output
```{r}
# Export interaction tables
for (dv in dvs_standard) {
  export_regression_table(
    interaction_unadj$models, interaction_adj$models,
    interaction_unadj_female$models, interaction_adj_female$models,
    interaction_unadj_male$models, interaction_adj_male$models,
    dv = dv,
    output_path = paste0(reg_dir, "interaction_models_", dv, "_interaction.xlsx"),
    term_labels_map = term_labels_interaction,
    filter_terms = ":year2020"
  )
}
```

# Migrant Regressions (Cognitive/Independence Difficulty)
```{r}
dvs_migrant <- c("cognitive_difficulty", "independent_living_difficulty")
ivs_migrant <- c("married_cohab", "age_at_immigration_25to49", "age_at_immigration_50plus",
                 "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "female",
                 "country_string", "lives_alone", "english_speaker", "secondary_or_above",
                 "age_70to79", "age_80to89", "age_90plus")

us_df_2020_migrant <- us_df_2020 %>%
  filter(country_string %in% main_countries) %>%
  mutate(country_string = fct_relevel(country_string, "mexico"))

results_migrant <- list()

for (dv in dvs_migrant) {
  formula <- as.formula(paste(dv, "~", paste(ivs_migrant, collapse = " + ")))
  results_migrant[[dv]] <- lm(formula, data = us_df_2020_migrant, weights = perwt)
}

# Print summaries
walk2(results_migrant, names(results_migrant), ~{
  cat("\n\nSummary for", .y, ":\n")
  print(summary(.x))
})

# Export to Excel
excel_data <- map(results_migrant, tidy)
write_xlsx(excel_data, path = paste0(reg_dir, "within_US_model_summaries.xlsx"))
```

## Emmeans Analysis
```{r}
emm_options(rg.limit = 70000)

emm_results <- map(results_migrant, ~ emmeans(.x,
                                              specs = "country_string",
                                              at = list(married_cohab = 0,
                                                       age_at_immigration_25to49 = 0,
                                                       age_at_immigration_50plus = 0,
                                                       yrimm_before1965 = 0,
                                                       yrimm_1965to1980 = 0,
                                                       yrimm_1980to1999 = 0,
                                                       female = 0,
                                                       lives_alone = 0,
                                                       english_speaker = 0,
                                                       secondary_or_above = 0)))

emm_tables <- map(emm_results, ~ summary(.x, infer = TRUE) %>%
                  as.data.frame() %>%
                  select(country_string, emmean, SE, lower.CL, upper.CL))

# NOTE: Emmeans plots have been moved to 06_regression_plots.Rmd
# The emm_tables object is used there for visualization
print(emm_tables)
```

# Migrant-Specific Regressions (GLM)
```{r}
dvs_glm <- c("married_cohab", "age_at_immigration_under15", "age_at_immigration_15to49",
             "age_at_immigration_50plus", "secondary_or_above", "less_than_primary_completed",
             "primary_completed", "secondary_completed", "university_completed",
             "yrimm_before1965", "yrimm_1965to1980", "yrimm_1980to1999", "yrimm_2000plus",
             "is_naturalized_citizen", "female", "english_speaker")

ivs_glm <- c("country_string", "age_70to79", "age_80to89")

results_glm <- list()

for (dv in dvs_glm) {
  formula <- as.formula(paste(dv, "~", paste(ivs_glm, collapse = " + ")))
  results_glm[[dv]] <- glm(formula, data = us_df_2020_migrant,
                           family = binomial(), weights = perwt)
}

# Print summaries
walk2(results_glm, names(results_glm), ~{
  cat("\n\nSummary for", .y, ":\n")
  print(summary(.x))
})

# Export to Excel
excel_data_glm <- map(results_glm, tidy)
write_xlsx(excel_data_glm, path = paste0(reg_dir, "within_US_model_summaries_glm.xlsx"))
```

# Age at Migration Analysis

## Education by Age at Immigration
```{r}
education_models <- map(main_countries, ~run_outcome_model(us_df_2020, "primary_or_above", .x))
names(education_models) <- main_countries

summary(education_models$mexico)

education_emms <- map2_dfr(education_models, names(education_models), ~{
  get_emmeans_summary(.x, english_speaker = 1) %>% mutate(country = .y)
})

print(education_emms)

# NOTE: Emmeans line plots have been moved to 06_regression_plots.Rmd
```

## Citizenship by Age at Immigration
```{r}
citizen_models <- map(countries_no_pr, ~run_outcome_model(us_df_2020, "is_naturalized_citizen", .x))
names(citizen_models) <- countries_no_pr

citizen_emms <- map2_dfr(citizen_models, names(citizen_models), ~{
  get_emmeans_summary(.x, english_speaker = 1) %>% mutate(country = .y)
})

print(citizen_emms)

# NOTE: Emmeans line plots have been moved to 06_regression_plots.Rmd
```

## English Speaking by Age at Immigration
```{r}
# Models without english_speaker predictor (since it's the outcome)
english_models <- map(countries_no_pr, ~{
  run_outcome_model(us_df_2020, "english_speaker", .x, include_english = FALSE)
})
names(english_models) <- countries_no_pr

# Puerto Rico model without citizenship predictor
english_model_pr <- run_outcome_model(us_df_2020, "english_speaker", "puerto rico",
                                      include_citizen = FALSE, include_english = FALSE)

english_emms <- map2_dfr(english_models, names(english_models), ~{
  get_emmeans_summary(.x, is_naturalized_citizen = 1) %>% mutate(country = .y)
})

english_emm_pr <- get_emmeans_summary(english_model_pr) %>% mutate(country = "puerto rico")

all_english_emms <- bind_rows(english_emms, english_emm_pr)

print(all_english_emms)

# NOTE: Emmeans line plots have been moved to 06_regression_plots.Rmd
```
