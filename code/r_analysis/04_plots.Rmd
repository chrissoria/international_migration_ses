---
title: "plots"
author: "Chris Soria"
date: "2025-01-08"
output: html_document
---

# Libraries
```{r}
library(ggplot2)
library(dplyr)
library(purrr)
library(patchwork)
library(cowplot)
library(tidyverse)
library(haven)
```

# Setup
```{r setup, include=FALSE}
target_dir <- normalizePath("/Users/chrissoria/Documents/Research/us_international_ses/code")
current_dir <- normalizePath(getwd())

if (current_dir == target_dir) {
  out_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/code/")
  data_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/data/")
  plot_dir <- file.path("/Users/chrissoria/Documents/Research/us_international_ses/plots/")
} else {
  out_dir <- file.path("C:/Users/Ty/Desktop/ses_international/code/")
  data_dir <- file.path("C:/Users/Ty/Desktop/ses_international/data/")
  plot_dir <- file.path("C:/Users/Ty/Desktop/ses_international/plots/")
}

print(getwd())
```

# Load Data
```{r}
us_df_2010 <- read_dta(paste0(data_dir, "US_2010_v100.dta"))
us_df_2020 <- read_dta(paste0(data_dir, "US_2020_v100.dta"))
```

# Defining Reusable Functions
```{r}
# Color palettes
cohort_colors <- c(
  "Before 1965" = "lightgreen",
  "1965 - 1979" = "red",
  "1980 - 1999" = "orange",
  "After 1999" = "skyblue"
)

age_at_immig_colors <- c(
  "Under 15" = "#66c2a5",
  "15-24" = "#fc8d62",
  "25-49" = "pink",
  "50 and above" = "#8da0cb"
)

main_countries <- c("mexico", "puerto rico", "dominican republic", "cuba")

# Generic function to create horizontal bar plots by country
create_country_bar_plot <- function(country_data, fill_var, fill_colors, title_text) {
  ggplot(country_data, aes(x = proportion, y = .data[[fill_var]], fill = .data[[fill_var]])) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              hjust = -0.1, size = 3) +
    scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
    scale_fill_manual(values = fill_colors) +
    labs(title = title_text,
         x = element_blank(),
         y = element_blank()) +
    theme_cowplot() +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "none",
          axis.title.x = element_blank())
}

# Function to compute weighted means by group for each country
compute_country_summary <- function(data, countries, group_var, summary_var, weight_var = "perwt") {
  result_list <- list()

  for (country in countries) {
    country_data <- data %>%
      filter(country_string == country) %>%
      group_by(.data[[group_var]]) %>%
      summarise(
        value = weighted.mean(.data[[summary_var]], .data[[weight_var]], na.rm = TRUE),
        .groups = "drop"
      )
    result_list[[country]] <- country_data$value
  }

  # Get group levels from last iteration
  group_levels <- data %>%
    filter(country_string == countries[length(countries)]) %>%
    group_by(.data[[group_var]]) %>%
    summarise(.groups = "drop") %>%
    pull(.data[[group_var]])

  data.frame(
    group = group_levels,
    do.call(cbind, result_list)
  )
}

# Function to create combined country panel plots
create_combined_country_panels <- function(data_long, fill_var, fill_colors,
                                           main_title, subtitle_text = "Based on 2020 dataset",
                                           ncol = 2) {
  country_plots <- data_long %>%
    split(.$country) %>%
    map(~create_country_bar_plot(.x, fill_var, fill_colors, unique(.x$country)))

  combined_plot <- wrap_plots(country_plots, ncol = ncol) +
    plot_annotation(
      title = main_title,
      subtitle = subtitle_text,
      theme = theme(plot.title = element_text(hjust = 0.5, size = 14),
                    plot.subtitle = element_text(hjust = 0.5, size = 12))
    ) &
    theme(legend.position = "bottom")

  combined_plot +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")
}
```

# Plots Using Raw Data (Self-Contained)

## English Speakers by Immigration Cohort
```{r}
prop_english_cohort <- compute_country_summary(
  us_df_2020, main_countries,
  "year_of_immig_groups_string", "english_speaker"
) %>%
  rename(year_of_immigration_groups = group) %>%
  mutate(year_of_immigration_groups = factor(year_of_immigration_groups,
                                             levels = c("Before 1965", "1965 - 1979", "1980 - 1999", "After 1999")))

prop_english_cohort_long <- prop_english_cohort %>%
  pivot_longer(cols = -year_of_immigration_groups,
               names_to = "country",
               values_to = "proportion") %>%
  mutate(country = str_to_title(country))

combined_plot <- create_combined_country_panels(
  prop_english_cohort_long,
  fill_var = "year_of_immigration_groups",
  fill_colors = cohort_colors,
  main_title = "Proportion of English Speakers by Immigration Cohort and Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "migration_cohort_english_speaker_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## Education (Secondary+) by Immigration Cohort
```{r}
# Need to add secondary_or_above if not present
if (!"secondary_or_above" %in% names(us_df_2020)) {
  us_df_2020 <- us_df_2020 %>%
    mutate(secondary_or_above = secondary_completed + university_completed)
}

prop_educ_cohort <- compute_country_summary(
  us_df_2020, main_countries,
  "year_of_immig_groups_string", "secondary_or_above"
) %>%
  rename(year_of_immigration_groups = group) %>%
  mutate(year_of_immigration_groups = factor(year_of_immigration_groups,
                                             levels = c("Before 1965", "1965 - 1979", "1980 - 1999", "After 1999")))

prop_educ_cohort_long <- prop_educ_cohort %>%
  pivot_longer(cols = -year_of_immigration_groups,
               names_to = "country",
               values_to = "proportion") %>%
  mutate(country = str_to_title(country))

combined_plot <- create_combined_country_panels(
  prop_educ_cohort_long,
  fill_var = "year_of_immigration_groups",
  fill_colors = cohort_colors,
  main_title = "Proportion with At Least Secondary Education by Immigration Cohort and Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "migration_cohort_education_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## Education by Age at Immigration
```{r}
prop_educ_age_immig <- compute_country_summary(
  us_df_2020, main_countries,
  "age_at_immig_groups_string", "secondary_or_above"
) %>%
  rename(age_at_immig_groups = group) %>%
  mutate(age_at_immig_groups = factor(age_at_immig_groups,
                                      levels = c("Under 15", "15-24", "25-49", "50 and above")))

prop_educ_age_immig_long <- prop_educ_age_immig %>%
  pivot_longer(cols = -age_at_immig_groups,
               names_to = "country",
               values_to = "proportion") %>%
  mutate(country = str_to_title(country))

combined_plot <- create_combined_country_panels(
  prop_educ_age_immig_long,
  fill_var = "age_at_immig_groups",
  fill_colors = age_at_immig_colors,
  main_title = "Proportion with At Least Secondary Education by Age at Immigration and Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "age_at_immig_education_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## English Speakers by Age at Immigration
```{r}
prop_english_age_immig <- compute_country_summary(
  us_df_2020, main_countries,
  "age_at_immig_groups_string", "english_speaker"
) %>%
  rename(age_at_immig_groups = group) %>%
  mutate(age_at_immig_groups = factor(age_at_immig_groups,
                                      levels = c("Under 15", "15-24", "25-49", "50 and above")))

prop_english_age_immig_long <- prop_english_age_immig %>%
  pivot_longer(cols = -age_at_immig_groups,
               names_to = "country",
               values_to = "proportion") %>%
  mutate(country = str_to_title(country))

combined_plot <- create_combined_country_panels(
  prop_english_age_immig_long,
  fill_var = "age_at_immig_groups",
  fill_colors = age_at_immig_colors,
  main_title = "Proportion of English Speakers by Age at Immigration and Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "age_at_immig_english_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## Citizenship by Age at Immigration
```{r}
# Exclude Puerto Rico (all are citizens by birth)
countries_no_pr <- c("mexico", "dominican republic", "cuba")

prop_citizen_age_immig <- compute_country_summary(
  us_df_2020, countries_no_pr,
  "age_at_immig_groups_string", "is_naturalized_citizen"
) %>%
  rename(age_at_immig_groups = group) %>%
  mutate(age_at_immig_groups = factor(age_at_immig_groups,
                                      levels = c("Under 15", "15-24", "25-49", "50 and above")))

prop_citizen_age_immig_long <- prop_citizen_age_immig %>%
  pivot_longer(cols = -age_at_immig_groups,
               names_to = "country",
               values_to = "proportion") %>%
  mutate(country = str_to_title(country))

combined_plot <- create_combined_country_panels(
  prop_citizen_age_immig_long,
  fill_var = "age_at_immig_groups",
  fill_colors = age_at_immig_colors,
  main_title = "Proportion of Naturalized Citizens by Age at Immigration and Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "age_at_immig_citizen_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## Proportion by Age at Immigration (Distribution)
```{r}
result_list <- list()

for (country in main_countries) {
  prop_cohort_age_at_immig <- us_df_2020 %>%
    filter(country_string == country) %>%
    summarise(
      `Under 15` = weighted.mean(age_at_immigration_under15, perwt, na.rm = TRUE),
      `15-24` = weighted.mean(age_at_immigration_15to24, perwt, na.rm = TRUE),
      `25-49` = weighted.mean(age_at_immigration_25to49, perwt, na.rm = TRUE),
      `50 and above` = weighted.mean(age_at_immigration_50plus, perwt, na.rm = TRUE)
    )
  result_list[[country]] <- prop_cohort_age_at_immig
}

prop_age_at_immig <- bind_rows(result_list, .id = "country") %>%
  pivot_longer(cols = -country, names_to = "age_at_immig_groups", values_to = "proportion") %>%
  mutate(
    country = str_to_title(country),
    age_at_immig_groups = factor(age_at_immig_groups, levels = c("Under 15", "15-24", "25-49", "50 and above"))
  )

combined_plot <- create_combined_country_panels(
  prop_age_at_immig,
  fill_var = "age_at_immig_groups",
  fill_colors = age_at_immig_colors,
  main_title = "Proportion of Age at Immigration by Country of Origin"
)

print(combined_plot)
ggsave(filename = paste0(plot_dir, "age_at_immig_prop_panels.jpg"),
       plot = combined_plot, width = 12, height = 9, dpi = 300)
```

## Education Levels Within Migration Cohorts (Faceted)
```{r}
groups <- c("Under 15", "15-24", "25-49", "50 and above")

for (country in main_countries) {
  result_list <- list()

  for (group in groups) {
    prop_cohort_educated <- us_df_2020 %>%
      filter(country_string == country) %>%
      filter(age_at_immig_groups_string == group) %>%
      summarise(
        less_than_primary = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
        primary = weighted.mean(primary_completed, perwt, na.rm = TRUE),
        secondary = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
        university = weighted.mean(university_completed, perwt, na.rm = TRUE)
      )
    result_list[[group]] <- prop_cohort_educated
  }

  prop_age_education <- do.call(rbind, result_list) %>%
    rownames_to_column("age_group")

  prop_age_education_long <- prop_age_education %>%
    pivot_longer(cols = -age_group,
                 names_to = "education_level",
                 values_to = "proportion") %>%
    mutate(education_level = str_to_title(education_level))

  p <- ggplot(prop_age_education_long, aes(x = education_level, y = proportion, fill = education_level)) +
    geom_bar(stat = "identity") +
    facet_wrap(~ age_group, scales = "free_y") +
    coord_cartesian(ylim = c(0, 0.75)) +
    theme_minimal() +
    labs(title = paste("Education Levels by Age Group for", str_to_title(country), "Immigrants"),
         x = "Education Level",
         y = "Proportion") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none") +
    scale_fill_brewer(palette = "Set2")

  ggsave(paste0(plot_dir, "within_migration_cohort_education_levels_", country, ".png"),
         plot = p, width = 12, height = 8)
}
```

# Plots Requiring International Comparison Table
# NOTE: These plots require loading international census data.
# If international data is not available, these sections will be skipped.

```{r load_international_data, warning=FALSE, message=FALSE}
# Try to load international data files
intl_files <- c(
  mexico = paste0(data_dir, "Mexico_v100.dta"),
  dr = paste0(data_dir, "DR_v100.dta"),
  pr = paste0(data_dir, "PR_v100.dta"),
  cuba = paste0(data_dir, "Cuba_v100.dta")
)

intl_data_available <- all(file.exists(intl_files))

if (intl_data_available) {
  mexico_df <- read_dta(intl_files["mexico"])
  dr_df <- read_dta(intl_files["dr"])
  pr_df <- read_dta(intl_files["pr"])
  cuba_df <- read_dta(intl_files["cuba"])

  in_df <- bind_rows(
    mexico_df %>% mutate(country_string = "Mexico"),
    dr_df %>% mutate(country_string = "DR"),
    pr_df %>% mutate(country_string = "PR"),
    cuba_df %>% mutate(country_string = "Cuba")
  )

  message("International data loaded successfully")
} else {
  message("International data files not found - international comparison plots will be skipped")
}
```

```{r create_table1_for_plots, eval=intl_data_available}
# Create table1 for international comparison plots
# This combines native country data with US migrant data by sex

create_sex_summary <- function(df, sex_val, country_col = "country_string") {
  df %>%
    filter(sex == sex_val) %>%
    group_by(.data[[country_col]]) %>%
    summarise(
      mean_age_60_69 = weighted.mean(age_60to69, perwt, na.rm = TRUE),
      mean_age_70_79 = weighted.mean(age_70to79, perwt, na.rm = TRUE),
      mean_age_80_89 = weighted.mean(age_80to89, perwt, na.rm = TRUE),
      mean_married_cohab = weighted.mean(married_cohab, perwt, na.rm = TRUE),
      mean_less_than_primary = weighted.mean(less_than_primary_completed, perwt, na.rm = TRUE),
      mean_primary = weighted.mean(primary_completed, perwt, na.rm = TRUE),
      mean_secondary = weighted.mean(secondary_completed, perwt, na.rm = TRUE),
      mean_university = weighted.mean(university_completed, perwt, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    pivot_longer(cols = -all_of(country_col), names_to = "variable", values_to = "value") %>%
    pivot_wider(names_from = all_of(country_col), values_from = value)
}

# International (native country) summaries
intl_female <- create_sex_summary(in_df, 2)
intl_male <- create_sex_summary(in_df, 1)

# US migrant summaries
us_countries <- c("mexico", "puerto rico", "dominican republic", "cuba")
us_female <- us_df_2020 %>%
  filter(country_string %in% us_countries) %>%
  create_sex_summary(2)
us_male <- us_df_2020 %>%
  filter(country_string %in% us_countries) %>%
  create_sex_summary(1)

# Combine into table1 format expected by plots
table1 <- bind_rows(
  intl_female %>% select(-variable) %>%
    rename(Mexicans = Mexico, `Puerto Ricans` = PR, Dominicans = DR, Cubans = Cuba),
  intl_male %>% select(-variable) %>%
    rename(Mexicans = Mexico, `Puerto Ricans` = PR, Dominicans = DR, Cubans = Cuba)
)

# Add US migrant columns
us_female_wide <- us_female %>%
  select(-variable) %>%
  rename(`US Mexican-born` = mexico, `US Puerto-Rican-born` = `puerto rico`,
         `US Dominican-born` = `dominican republic`, `US Cuban-born` = cuba)
us_male_wide <- us_male %>%
  select(-variable) %>%
  rename(`US Mexican-born` = mexico, `US Puerto-Rican-born` = `puerto rico`,
         `US Dominican-born` = `dominican republic`, `US Cuban-born` = cuba)

table1 <- bind_cols(table1, bind_rows(us_female_wide, us_male_wide))
```

```{r intl_comparison_plots, eval=intl_data_available}
countries_intl <- c("Mexicans", "Puerto Ricans", "Dominicans", "Cubans",
                    "US Mexican-born", "US Puerto-Rican-born", "US Dominican-born", "US Cuban-born")

# Generic function for creating stacked bar plots from table1
create_stacked_bar_from_table <- function(table_data, row_indices, column_name,
                                          level_names, level_colors, gender) {
  values <- as.numeric(table_data[row_indices, column_name])
  unknown_val <- max(0, 1 - sum(values, na.rm = TRUE))

  prop_data <- data.frame(
    levels = factor(c(level_names, "unknown"), levels = c(level_names, "unknown")),
    proportion = c(values, unknown_val)
  )

  colors_with_unknown <- c(level_colors, "unknown" = "gray")

  ggplot(prop_data, aes(x = "", y = proportion, fill = levels)) +
    geom_bar(stat = "identity", width = 0.5) +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), size = 3) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = colors_with_unknown,
                      labels = c("Less than Primary", "Primary", "Secondary", "University", "Unknown")) +
    labs(title = paste(column_name, "-", gender),
         y = element_blank(),
         x = NULL) +
    theme_cowplot() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "none",
          plot.title = element_text(hjust = 0.5))
}

# Education plots
# Rows 5:8 = education for women (less_than_primary, primary, secondary, university)
# Rows 13:16 = education for men (offset by 8 rows for male section)
education_levels <- c("less_than_primary", "primary", "secondary", "university")
education_colors <- c("less_than_primary" = "skyblue",
                      "primary" = "lightgreen",
                      "secondary" = "red",
                      "university" = "orange")

plots_women <- map(countries_intl, ~create_stacked_bar_from_table(
  table1, 5:8, .x, education_levels, education_colors, "Women"))
plots_men <- map(countries_intl, ~create_stacked_bar_from_table(
  table1, 13:16, .x, education_levels, education_colors, "Men"))

combined_women <- wrap_plots(plots_women, ncol = 4) +
  plot_annotation(
    title = "Education Levels by Country - Women",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_women <- combined_women + plot_layout(guides = "collect") & theme(legend.position = "bottom")

combined_men <- wrap_plots(plots_men, ncol = 4) +
  plot_annotation(
    title = "Education Levels by Country - Men",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_men <- combined_men + plot_layout(guides = "collect") & theme(legend.position = "bottom")

print(combined_women)
print(combined_men)

ggsave(filename = paste0(plot_dir, "education_panels_women.jpg"), plot = combined_women, width = 15, height = 10, dpi = 300)
ggsave(filename = paste0(plot_dir, "education_panels_men.jpg"), plot = combined_men, width = 15, height = 10, dpi = 300)
```

```{r marital_plots, eval=intl_data_available}
# Marital status plots
# Row 4 = married/cohabiting for women, Row 12 for men
create_binary_bar_from_table <- function(table_data, row_index, column_name, gender,
                                         yes_label = "Yes", no_label = "No",
                                         yes_color = "lightblue", no_color = "pink") {
  value <- as.numeric(table_data[row_index, column_name])

  prop_data <- data.frame(
    levels = factor(c(yes_label, no_label), levels = c(yes_label, no_label)),
    proportion = c(value, 1 - value)
  )

  ggplot(prop_data, aes(x = "", y = proportion, fill = levels)) +
    geom_bar(stat = "identity", width = 0.5) +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), size = 3) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = c(yes_color, no_color)) +
    labs(title = paste(column_name, "-", gender),
         y = element_blank(),
         x = NULL) +
    theme_cowplot() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "none",
          plot.title = element_text(hjust = 0.5))
}

plots_women <- map(countries_intl, ~create_binary_bar_from_table(
  table1, 4, .x, "Women", "Married", "Not Married"))
plots_men <- map(countries_intl, ~create_binary_bar_from_table(
  table1, 12, .x, "Men", "Married", "Not Married"))

combined_women <- wrap_plots(plots_women, ncol = 4) +
  plot_annotation(
    title = "Marital Status by Country - Women",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_women <- combined_women + plot_layout(guides = "collect") & theme(legend.position = "bottom")

combined_men <- wrap_plots(plots_men, ncol = 4) +
  plot_annotation(
    title = "Marital Status by Country - Men",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_men <- combined_men + plot_layout(guides = "collect") & theme(legend.position = "bottom")

print(combined_women)
print(combined_men)

ggsave(filename = paste0(plot_dir, "marital_status_panels_women.jpg"), plot = combined_women, width = 15, height = 10, dpi = 300)
ggsave(filename = paste0(plot_dir, "marital_status_panels_men.jpg"), plot = combined_men, width = 15, height = 10, dpi = 300)
```

```{r age_distribution_plots, eval=intl_data_available}
# Age distribution plots
# Rows 1:3 = age groups for women (60-69, 70-79, 80-89)
# Rows 9:11 = age groups for men
age_groups <- c("Age 60-69", "Age 70-79", "Age 80-89")
age_colors <- c("Age 60-69" = "lightblue", "Age 70-79" = "orange", "Age 80-89" = "lightgreen")

create_age_bar_from_table <- function(table_data, row_indices, column_name, gender) {
  values <- as.numeric(table_data[row_indices, column_name])

  prop_data <- data.frame(
    levels = factor(age_groups, levels = age_groups),
    proportion = values
  )

  ggplot(prop_data, aes(x = "", y = proportion, fill = levels)) +
    geom_bar(stat = "identity", width = 0.5) +
    geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)),
              position = position_stack(vjust = 0.5), size = 3) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_manual(values = age_colors) +
    labs(title = paste(column_name, "-", gender),
         y = element_blank(),
         x = NULL) +
    theme_cowplot() +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = "none",
          plot.title = element_text(hjust = 0.5))
}

plots_women <- map(countries_intl, ~create_age_bar_from_table(table1, 1:3, .x, "Women"))
plots_men <- map(countries_intl, ~create_age_bar_from_table(table1, 9:11, .x, "Men"))

combined_women <- wrap_plots(plots_women, ncol = 4) +
  plot_annotation(
    title = "Age Distribution by Country - Women",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_women <- combined_women + plot_layout(guides = "collect") & theme(legend.position = "bottom")

combined_men <- wrap_plots(plots_men, ncol = 4) +
  plot_annotation(
    title = "Age Distribution by Country - Men",
    subtitle = "Comparing native country populations with US immigrants",
    theme = theme(plot.title = element_text(hjust = 0.5),
                  plot.subtitle = element_text(hjust = 0.5))
  ) &
  theme(legend.position = "bottom")
combined_men <- combined_men + plot_layout(guides = "collect") & theme(legend.position = "bottom")

print(combined_women)
print(combined_men)

ggsave(filename = paste0(plot_dir, "age_distribution_panels_women.jpg"), plot = combined_women, width = 15, height = 10, dpi = 300)
ggsave(filename = paste0(plot_dir, "age_distribution_panels_men.jpg"), plot = combined_men, width = 15, height = 10, dpi = 300)
```

# Additional Self-Contained Plots

## IMR Over Time Plot
```{r imr_plot}
countries_of_interest <- c("Mexico", "Puerto Rico", "Dominican Republic", "Cuba")
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#CC79A7")

# Load IMR data
IMR <- read.csv(paste0(data_dir, "UNdata_Export_20250327_063538285.csv")) %>%
  filter(grepl(paste(countries_of_interest, collapse = "|"), Country.or.Area, ignore.case = TRUE)) %>%
  filter(Country.or.Area != "United States-Mexico-Canada Agreement (USMCA)") %>%
  filter(Year.s. < 2020) %>%
  mutate(Country.or.Area = fct_relevel(Country.or.Area, "Mexico", "Puerto Rico", "Dominican Republic", "Cuba"))

IMR_plot <- ggplot(IMR, aes(x = Year.s., y = Value, group = Country.or.Area, color = Country.or.Area)) +
  geom_line(size = 1) +
  labs(title = NULL, x = "Year", y = "Infant Mortality Rate (per 1,000 births)", color = "Country") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.90, 0.90),
        legend.text = element_text(face = "bold"),
        legend.justification = c("right", "top")) +
  scale_color_manual(values = cbPalette)

ggsave(filename = file.path(plot_dir, "IMR_over_time.png"), plot = IMR_plot,
       device = "png", width = 12, height = 6, dpi = 300)
IMR_plot
```

## Stress Data Visualization
```{r stress_data}
stress_data <- data.frame(
  Group = c("Mexican", "Puerto Rican", "Cuban", "Central American", "South American", "Dominican"),
  Parental = c(17.78, 14.25, 15.65, 14.66, 15.62, 14.83),
  Parental_SD = c(8.60, 3.93, 7.61, 5.28, 5.78, 4.25),
  Marital = c(15.83, 14.28, 12.95, 13.54, 15.13, 13.22),
  Marital_SD = c(7.98, 5.66, 4.49, 6.26, 7.43, 4.53),
  Occupational = c(18.11, 16.14, 16.94, 16.46, 19.44, 17.22),
  Occupational_SD = c(8.45, 6.19, 8.32, 6.67, 9.58, 6.82),
  Discrimination = c(12.87, 12.37, 11.34, 12.35, 12.51, 12.11),
  Discrimination_SD = c(5.24, 4.46, 3.94, 4.85, 5.78, 3.93),
  Immigration = c(13.41, 10.38, 9.75, 10.68, 11.43, 9.98),
  Immigration_SD = c(7.43, 3.60, 2.23, 4.20, 5.62, 2.55),
  Marital_Acculturation = c(11.09, 10.06, 10.10, 9.45, 10.57, 9.78),
  Marital_Acculturation_SD = c(4.68, 2.92, 2.98, 1.56, 3.13, 2.20),
  Health = c(13.23, 9.35, 11.14, 10.18, 13.05, 9.87),
  Health_SD = c(7.08, 2.25, 5.42, 4.35, 7.79, 4.69),
  Language = c(9.97, 6.95, 8.89, 8.99, 8.82, 11.42),
  Language_SD = c(5.21, 2.16, 4.93, 4.88, 4.43, 5.55),
  Premigration = c(9.80, 6.92, 8.44, 8.28, 8.12, 9.17),
  Premigration_SD = c(5.92, 1.89, 4.16, 4.27, 4.04, 4.30),
  Family = c(7.93, 6.50, 6.78, 7.03, 7.74, 6.72),
  Family_SD = c(3.95, 2.50, 3.57, 2.88, 4.09, 2.37),
  Total = c(115.17, 89.29, 97.95, 100.28, 111.94, 99.10),
  Total_SD = c(44.15, 15.29, 32.28, 25.24, 39.93, 18.73)
)

ggplot(stress_data, aes(x = Group, y = Health)) +
  geom_point(color = "black", size = 3) +
  theme_light() +
  labs(title = "Self-Rated Health Stress by Hispanic/Latino Group",
       x = "Country of Birth", y = "Health Stress") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))
```
